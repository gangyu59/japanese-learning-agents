// ‰øùÂ≠ò‰∏∫: frontend/multi_agent_collaboration.js
/**
 * Â§öÊô∫ËÉΩ‰ΩìÂçè‰ΩúÂâçÁ´ØÂäüËÉΩ
 * Âü∫‰∫é‰Ω†Áé∞ÊúâÁöÑÂâçÁ´ØÁªìÊûÑ
 */

class MultiAgentCollaboration {
    constructor() {
        this.apiBase = '';  // Áõ∏ÂØπË∑ØÂæÑÔºåÂõ†‰∏∫ÂâçÁ´ØÂíåÂêéÁ´ØÂú®Âêå‰∏ÄÂüü
        this.activeAgents = new Set();
        this.collaborationMode = 'discussion';
        this.currentSession = null;

        // Êô∫ËÉΩ‰ΩìÊò†Â∞ÑË°®
        this.agentMap = {
            'tanaka': 'Áî∞‰∏≠ÂÖàÁîü',
            'koumi': 'Â∞èÁæé',
            'ai': '„Ç¢„Ç§',
            'yamada': 'Â±±Áî∞ÂÖàÁîü',
            'sato': '‰ΩêËó§ÊïôÁªÉ',
            'membot': 'MemBot'
        };

        this.init();
    }

    init() {
        // Ê£ÄÊü•ÊòØÂê¶Âú®Ê≠£Á°ÆÈ°µÈù¢
        if (!document.getElementById('multi-agent-controls')) {
            return; // ‰∏çÂú®Âçè‰ΩúÈ°µÈù¢ÔºåË∑≥ËøáÂàùÂßãÂåñ
        }

        this.setupEventListeners();
        this.loadAgentsList();
    }

    setupEventListeners() {
        // Êô∫ËÉΩ‰ΩìÈÄâÊã©
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('agent-checkbox')) {
                this.handleAgentToggle(e.target);
            }
        });

        // Âçè‰ΩúÊ®°ÂºèÈÄâÊã©
        document.addEventListener('change', (e) => {
            if (e.target.name === 'collaboration-mode') {
                this.collaborationMode = e.target.value;
                this.updateModeDescription();
            }
        });

        // ÂèëÈÄÅÊåâÈíÆ
        const sendBtn = document.getElementById('send-multi-agent');
        if (sendBtn) {
            sendBtn.addEventListener('click', () => this.sendMessage());
        }

        // ÂõûËΩ¶ÂèëÈÄÅ
        const input = document.getElementById('multi-agent-input');
        if (input) {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }
    }

    async loadAgentsList() {
        try {
            const response = await fetch('/api/v1/agents/list');
            const agents = await response.json();
            this.renderAgentsSelection(agents);
        } catch (error) {
            console.error('Âä†ËΩΩÊô∫ËÉΩ‰ΩìÂàóË°®Â§±Ë¥•:', error);
        }
    }

    renderAgentsSelection(agents) {
        const container = document.getElementById('agents-selection');
        if (!container) return;

        const html = agents.map(agent => `
            <div class="agent-option">
                <label class="agent-label">
                    <input type="checkbox" class="agent-checkbox" value="${agent.id}">
                    <span class="agent-info">
                        <span class="agent-avatar">${agent.avatar}</span>
                        <span class="agent-name">${agent.name}</span>
                        <span class="agent-role">${agent.role}</span>
                    </span>
                </label>
            </div>
        `).join('');

        container.innerHTML = html;
    }

    handleAgentToggle(checkbox) {
        const agentId = checkbox.value;

        if (checkbox.checked) {
            this.activeAgents.add(agentId);
        } else {
            this.activeAgents.delete(agentId);
        }

        this.updateCollaborationStatus();
    }

    updateCollaborationStatus() {
        const statusEl = document.getElementById('collaboration-status');
        const sendBtn = document.getElementById('send-multi-agent');

        if (this.activeAgents.size < 2) {
            if (statusEl) statusEl.textContent = 'ËØ∑ÈÄâÊã©Ëá≥Â∞ë2‰∏™Êô∫ËÉΩ‰ΩìËøõË°åÂçè‰Ωú';
            if (sendBtn) sendBtn.disabled = true;
        } else {
            if (statusEl) statusEl.textContent = `Â∑≤ÈÄâÊã©${this.activeAgents.size}‰∏™Êô∫ËÉΩ‰ΩìÔºåÂáÜÂ§áÂçè‰Ωú`;
            if (sendBtn) sendBtn.disabled = false;
        }
    }

    updateModeDescription() {
        const descriptions = {
            'discussion': 'Êô∫ËÉΩ‰Ωì‰ª¨Â∞ÜÂ∞±ÊÇ®ÁöÑÈóÆÈ¢òËøõË°åËá™Áî±ËÆ®ËÆ∫',
            'correction': 'Êô∫ËÉΩ‰Ωì‰ª¨Â∞ÜÂçè‰ΩúÁ∫†Ê≠£ÊÇ®ÁöÑËØ≠Ê≥ïÂíåÁî®Ê≥ïÈóÆÈ¢ò',
            'creation': 'Êô∫ËÉΩ‰Ωì‰ª¨Â∞ÜÂçè‰ΩúÂàõ‰ΩúÂÜÖÂÆπ',
            'analysis': 'Êô∫ËÉΩ‰Ωì‰ª¨Â∞Ü‰ªéÂ§ö‰∏™ËßíÂ∫¶Ê∑±ÂÖ•ÂàÜÊûêÈóÆÈ¢ò'
        };

        const descEl = document.getElementById('mode-description');
        if (descEl) {
            descEl.textContent = descriptions[this.collaborationMode] || '';
        }
    }

    async sendMessage() {
        const input = document.getElementById('multi-agent-input');
        const message = input?.value?.trim();

        if (!message || this.activeAgents.size < 2) return;

        const requestData = {
            message: message,
            user_id: 'demo_user',
            session_id: this.currentSession || 'session_' + Date.now(),
            active_agents: Array.from(this.activeAgents),
            collaboration_mode: this.collaborationMode,
            scene_context: 'multi_agent_collaboration'
        };

        // ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ
        this.displayUserMessage(message);
        if (input) input.value = '';

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        this.showThinkingIndicator();

        try {
            const response = await fetch('/api/v1/collaboration/multi-agent-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();

            if (data.success) {
                // ÊòæÁ§∫Êô∫ËÉΩ‰ΩìÂõûÂ§ç
                this.displayAgentResponses(data.responses);

                // ÊòæÁ§∫ÂÜ≤Á™ÅÔºàÂ¶ÇÊûúÊúâÔºâ
                if (data.conflicts && data.conflicts.length > 0) {
                    this.displayConflicts(data.conflicts);
                }

                // ÊòæÁ§∫ÊÄªÁªì
                if (data.final_recommendation) {
                    this.displaySummary(data.final_recommendation);
                }
            } else {
                this.displayError('Âçè‰ΩúËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }

        } catch (error) {
            console.error('Âçè‰ΩúËØ∑Ê±ÇÂ§±Ë¥•:', error);
            this.displayError('ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ËøûÊé•');
        } finally {
            this.hideThinkingIndicator();
        }
    }

    displayUserMessage(message) {
        const container = document.getElementById('messages-container');
        if (!container) return;

        const messageEl = document.createElement('div');
        messageEl.className = 'message user-message';
        messageEl.innerHTML = `
            <div class="message-content">
                <span class="message-author">ÊÇ®</span>
                <div class="message-text">${this.escapeHtml(message)}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            </div>
        `;

        container.appendChild(messageEl);
        this.scrollToBottom();
    }

    displayAgentResponses(responses) {
        const container = document.getElementById('messages-container');
        if (!container) return;

        responses.forEach((response, index) => {
            // Ê∑ªÂä†Âª∂Ëøü‰ª•Ê®°ÊãüÁúüÂÆûÂØπËØù
            setTimeout(() => {
                const messageEl = document.createElement('div');
                messageEl.className = 'message agent-message';
                messageEl.innerHTML = `
                    <div class="message-content">
                        <span class="message-author">
                            ${response.emotion || 'ü§ñ'} ${response.agent_name}
                            ${response.confidence ? `(${Math.round(response.confidence * 100)}%)` : ''}
                        </span>
                        <div class="message-text">${this.formatContent(response.content)}</div>
                        ${response.learning_points?.length ? 
                            `<div class="learning-points">
                                <strong>Â≠¶‰π†Ë¶ÅÁÇπ:</strong> ${response.learning_points.join(', ')}
                             </div>` : ''
                        }
                        ${response.suggestions?.length ?
                            `<div class="suggestions">
                                <strong>Âª∫ËÆÆ:</strong> ${response.suggestions.join(', ')}
                             </div>` : ''
                        }
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;

                container.appendChild(messageEl);
                this.scrollToBottom();
            }, index * 800); // ÊØè‰∏™Êô∫ËÉΩ‰ΩìÈó¥Èöî800ms
        });
    }

    displayConflicts(conflicts) {
        const container = document.getElementById('messages-container');
        if (!container) return;

        setTimeout(() => {
            const conflictEl = document.createElement('div');
            conflictEl.className = 'message conflict-message';
            conflictEl.innerHTML = `
                <div class="message-content conflict">
                    <span class="message-author">‚öñÔ∏è ËßÇÁÇπÂàÜÊ≠ß</span>
                    <div class="message-text">
                        Êô∫ËÉΩ‰Ωì‰ª¨ÂØπÊ≠§ÈóÆÈ¢òÊúâ‰∏çÂêåÁúãÊ≥ïÔºö
                        ${conflicts.map(c => `
                            <div class="conflict-item">
                                <strong>${this.agentMap[c.agent1] || c.agent1}</strong> vs 
                                <strong>${this.agentMap[c.agent2] || c.agent2}</strong>: 
                                ${c.conflict_point}
                            </div>
                        `).join('')}
                    </div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            container.appendChild(conflictEl);
            this.scrollToBottom();
        }, conflicts.length * 1000); // Âú®ÊâÄÊúâÊô∫ËÉΩ‰ΩìÂõûÂ§çÂêéÊòæÁ§∫
    }

    displaySummary(summary) {
        const container = document.getElementById('messages-container');
        if (!container) return;

        setTimeout(() => {
            const summaryEl = document.createElement('div');
            summaryEl.className = 'message summary-message';
            summaryEl.innerHTML = `
                <div class="message-content summary">
                    <span class="message-author">üí° Âçè‰ΩúÊÄªÁªì</span>
                    <div class="message-text">${this.formatContent(summary)}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            container.appendChild(summaryEl);
            this.scrollToBottom();
        }, 2000);
    }

    displayError(error) {
        const container = document.getElementById('messages-container');
        if (!container) return;

        const errorEl = document.createElement('div');
        errorEl.className = 'message error-message';
        errorEl.innerHTML = `
            <div class="message-content error">
                <span class="message-author">‚ùå ÈîôËØØ</span>
                <div class="message-text">${this.escapeHtml(error)}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            </div>
        `;

        container.appendChild(errorEl);
        this.scrollToBottom();
    }

    showThinkingIndicator() {
        const container = document.getElementById('messages-container');
        if (!container) return;

        const thinkingEl = document.createElement('div');
        thinkingEl.id = 'thinking-indicator';
        thinkingEl.className = 'message thinking-message';
        thinkingEl.innerHTML = `
            <div class="message-content thinking">
                <span class="message-author">ü§î Êô∫ËÉΩ‰Ωì‰ª¨Ê≠£Âú®ÊÄùËÄÉ...</span>
                <div class="thinking-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;

        container.appendChild(thinkingEl);
        this.scrollToBottom();
    }

    hideThinkingIndicator() {
        const thinkingEl = document.getElementById('thinking-indicator');
        if (thinkingEl) {
            thinkingEl.remove();
        }
    }

    formatContent(content) {
        return this.escapeHtml(content)
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    scrollToBottom() {
        const container = document.getElementById('messages-container');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    window.multiAgentCollaboration = new MultiAgentCollaboration();
});

// ÂØºÂá∫‰æõÂÖ∂‰ªñËÑöÊú¨‰ΩøÁî®
if (typeof module !== 'undefined' && module.exports) {
    module.exports = MultiAgentCollaboration;
}