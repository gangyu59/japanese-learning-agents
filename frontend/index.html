<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéå Êó•ËØ≠Â≠¶‰π†Multi-AgentÁ≥ªÁªü</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Êñ∞Â¢ûÔºöÈ°∂ÈÉ®ÂØºËà™Ê†è */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-brand h3 {
            margin: 0;
            color: #667eea;
        }

        .backend-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #fff3cd;
            color: #856404;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover {
            background: #f0f0f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px; /* Êñ∞Â¢ûÔºö‰∏∫ÂØºËà™Ê†èÁïôÂá∫Á©∫Èó¥ */
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }

        .chat-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .agent-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .agent-card.active {
            border-color: #4299e1;
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
        }

        .agent-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .agent-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .agent-role {
            font-size: 0.8em;
            color: #718096;
        }

        .agent-emotion {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeInUp 0.5s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            color: white;
            font-weight: bold;
        }

        .message-content {
            background: white;
            padding: 15px;
            border-radius: 15px;
            max-width: 70%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8em;
            color: #718096;
        }

        .message.user .message-meta {
            color: rgba(255,255,255,0.8);
        }

        .thinking-indicator {
            display: none;
            padding: 10px 20px;
            background: #fff3cd;
            border-radius: 20px;
            margin: 10px 0;
            font-style: italic;
            color: #856404;
        }

        .thinking-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-height: 50px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            resize: none;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            border-color: #4299e1;
        }

        .send-btn, .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .voice-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .send-btn:hover, .voice-btn:hover {
            transform: scale(1.1);
        }

        .learning-stats {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            transition: width 0.3s ease;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .action-btn:hover {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .scene-selector {
            margin-bottom: 20px;
        }

        .scene-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .collaboration-panel {
            background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .collaboration-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .agent-participation {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .participant-badge {
            background: #4299e1;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
        }

        .novel-creation {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-radius: 10px;
            padding: 15px;
        }

        .novel-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .novel-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: #48bb78;
            color: white;
            cursor: pointer;
            font-size: 0.8em;
        }

        .novel-progress {
            background: white;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .personality-sliders {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
        }

        .slider-group label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .slider {
            width: 100%;
        }

        .slider-value {
            text-align: center;
            font-weight: bold;
            color: #4299e1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
        }

        .achievements {
            background: linear-gradient(135deg, #faf5ff 0%, #e9d5ff 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
        }

        .achievement-item.unlocked {
            background: rgba(72, 187, 120, 0.1);
        }

        .achievement-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 1s;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: calc(100vh - 150px);
            }

            .sidebar {
                height: auto;
                max-height: 200px;
            }

            .agent-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav-links {
                display: none;
            }
        }
    </style>
    <link href="assets/css/voice-minimal.css" rel="stylesheet">
</head>
<body>
    <!-- Êñ∞Â¢ûÔºöÈ°∂ÈÉ®ÂØºËà™Ê†è -->
    <nav class="top-nav">
        <div class="nav-brand">
            <h3>üéå Êó•ËØ≠Â≠¶‰π†Á≥ªÁªü</h3>
            <span id="backendStatus" class="backend-status status-offline">üü° Ê£ÄÊµã‰∏≠...</span>
        </div>
        <div class="nav-links">
            <a href="#" onclick="navigateToPage('chat')">üí¨ ÂØπËØù</a>
            <a href="pages/agents.html">ü§ñ Êô∫ËÉΩ‰Ωì</a>
            <a href="pages/learning.html">üìö Â≠¶‰π†</a>
            <a href="pages/novel.html">üìñ Â∞èËØ¥</a>
            <a href="pages/multi_agent_collaboration.html">ü§ù Âçè‰Ωú</a>
            <a href="pages/progress.html">üìä ËøõÂ∫¶</a>
            <a href="pages/achievements.html">üèÜ ÊàêÂ∞±</a>
            <a href="pages/profile.html">üë§ Áî®Êà∑</a>
            <a href="pages/settings.html">‚öôÔ∏è ËÆæÁΩÆ</a>
            <a href="pages/user_guide.html">üìñ ÊåáÂçó</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üéå Êó•ËØ≠Â≠¶‰π†Multi-AgentÁ≥ªÁªü</h1>
            <p>‰∏éAIÊô∫ËÉΩ‰Ωì‰∏ÄËµ∑Â≠¶‰π†Êó•ËØ≠Ôºå‰ΩìÈ™åÂçè‰ΩúÂ≠¶‰π†ÁöÑ‰πêË∂£</p>
        </div>

        <div class="main-layout">
            <!-- Â∑¶‰æßËæπÊ†è - Êô∫ËÉΩ‰ΩìÁÆ°ÁêÜ -->
            <div class="sidebar">
                <h3><i class="fas fa-users"></i> Êô∫ËÉΩ‰ΩìÂõ¢Èòü</h3>
                <div class="agent-grid">
                    <div class="agent-card active" data-agent="tanaka">
                        <div class="agent-emotion">üòê</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);">üë®‚Äçüè´</div>
                        <div class="agent-name">Áî∞‰∏≠ÂÖàÁîü</div>
                        <div class="agent-role">ËØ≠Ê≥ï‰∏ìÂÆ∂</div>
                    </div>
                    <div class="agent-card" data-agent="koumi">
                        <div class="agent-emotion">üòä</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);">üëß</div>
                        <div class="agent-name">Â∞èÁæé</div>
                        <div class="agent-role">ÂØπËØù‰ºô‰º¥</div>
                    </div>
                    <div class="agent-card" data-agent="ai">
                        <div class="agent-emotion">ü§î</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);">ü§ñ</div>
                        <div class="agent-name">„Ç¢„Ç§</div>
                        <div class="agent-role">ÂàÜÊûêÂ∏à</div>
                    </div>
                    <div class="agent-card" data-agent="yamada">
                        <div class="agent-emotion">üòå</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);">üéå</div>
                        <div class="agent-name">Â±±Áî∞ÂÖàÁîü</div>
                        <div class="agent-role">ÊñáÂåñ‰∏ìÂÆ∂</div>
                    </div>
                    <div class="agent-card" data-agent="sato">
                        <div class="agent-emotion">üò§</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);">üéØ</div>
                        <div class="agent-name">‰ΩêËó§ÊïôÁªÉ</div>
                        <div class="agent-role">ËÄÉËØï‰∏ìÂÆ∂</div>
                    </div>
                    <div class="agent-card" data-agent="membot">
                        <div class="agent-emotion">üß†</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);">ü§ñ</div>
                        <div class="agent-name">ËÆ∞ÂøÜÁÆ°ÂÆ∂</div>
                        <div class="agent-role">Â≠¶‰π†ËÆ∞ÂΩï</div>
                    </div>
                </div>

                <div class="scene-selector">
                    <label><strong>ÈÄâÊã©Â≠¶‰π†Âú∫ÊôØ</strong></label>
                    <select id="sceneSelect">
                        <option value="grammar">ËØ≠Ê≥ïÂ≠¶‰π†</option>
                        <option value="conversation">Êó•Â∏∏ÂØπËØù</option>
                        <option value="restaurant">È§êÂéÖÂú∫ÊôØ</option>
                        <option value="shopping">Ë¥≠Áâ©Âú∫ÊôØ</option>
                        <option value="interview">Èù¢ËØïÂáÜÂ§á</option>
                        <option value="culture">ÊñáÂåñÊé¢Á¥¢</option>
                        <option value="jlpt">JLPTËÄÉËØï</option>
                    </select>
                </div>

                <div class="quick-actions">
                    <button class="action-btn" onclick="startGrammarCheck()">
                        <i class="fas fa-spell-check"></i><br>ËØ≠Ê≥ïÊ£ÄÊü•
                    </button>
                    <button class="action-btn" onclick="startVocabExpansion()">
                        <i class="fas fa-book"></i><br>ËØçÊ±áÊâ©Â±ï
                    </button>
                    <button class="action-btn" onclick="startCulturalContext()">
                        <i class="fas fa-torii-gate"></i><br>ÊñáÂåñËÉåÊôØ
                    </button>
                    <button class="action-btn" onclick="startJLPTPrep()">
                        <i class="fas fa-graduation-cap"></i><br>ËÄÉËØïÂáÜÂ§á
                    </button>
                </div>

                <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openAgentCreator()">
                    <i class="fas fa-plus"></i> ÂàõÂª∫Ëá™ÂÆö‰πâÊô∫ËÉΩ‰Ωì
                </button>

                <button class="btn-primary" style="width: 100%;" onclick="openSceneEditor()">
                    <i class="fas fa-edit"></i> ÁºñËæëÂ≠¶‰π†Âú∫ÊôØ
                </button>
            </div>

            <!-- ‰∏≠Â§ÆËÅäÂ§©Âå∫Âüü -->
            <div class="chat-area">
                <div class="collaboration-panel">
                    <div class="collaboration-status">
                        <strong>üìù Âçè‰ΩúÁä∂ÊÄÅ</strong>
                        <span id="activeAgentsCount">1 ‰∏™Êô∫ËÉΩ‰ΩìÊ¥ªË∑É</span>
                    </div>
                    <div class="agent-participation" id="activeAgentsList">
                        <span class="participant-badge">Áî∞‰∏≠ÂÖàÁîü</span>
                    </div>
                </div>

                <div class="thinking-indicator" id="thinkingIndicator">
                    <i class="fas fa-brain"></i> Êô∫ËÉΩ‰ΩìÊ≠£Âú®ÊÄùËÄÉ‰∏≠...
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);">üë®‚Äçüè´</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>Áî∞‰∏≠ÂÖàÁîü</strong>
                                <span>ÂàöÂàö</span>
                            </div>
                            <div>„Åì„Çì„Å´„Å°„ÅØÔºÅÊó•Êú¨Ë™û„ÅÆÂ≠¶Áøí„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ„Åæ„Åö„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊó•Êú¨Ë™û„É¨„Éô„É´„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂàùÁ¥ö„ÄÅ‰∏≠Á¥ö„ÄÅ‰∏äÁ¥ö„ÅÆ„Å©„Çå„Åß„Åô„ÅãÔºü</div>
                            <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                                <strong>‰∏≠ÊñáÁøªËØëÔºö</strong>‰Ω†Â•ΩÔºÅËÆ©Êàë‰ª¨ÂºÄÂßãÂ≠¶‰π†Êó•ËØ≠Âêß„ÄÇÈ¶ñÂÖàÔºåËØ∑ÂëäËØâÊàë‰Ω†ÁöÑÊó•ËØ≠Ê∞¥Âπ≥„ÄÇÊòØÂàùÁ∫ß„ÄÅ‰∏≠Á∫ßËøòÊòØÈ´òÁ∫ßÔºü
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <div class="input-group">
                        <textarea id="messageInput" class="input-field" placeholder="ËæìÂÖ•‰Ω†ÁöÑÊó•ËØ≠Êàñ‰∏≠Êñá..." rows="2"></textarea>
                        <button class="voice-btn" onclick="startVoiceInput()" title="ËØ≠Èü≥ËæìÂÖ•">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="send-btn" onclick="sendMessage()" title="ÂèëÈÄÅÊ∂àÊÅØ">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Âè≥‰æßËæπÊ†è - Â≠¶‰π†ËøõÂ∫¶ÂíåÂäüËÉΩ -->
            <div class="sidebar">
                <div class="learning-stats">
                    <h3><i class="fas fa-chart-line"></i> Â≠¶‰π†ËøõÂ∫¶</h3>
                    <div class="stat-item">
                        <span>ËØ≠Ê≥ïÊéåÊè°Â∫¶</span>
                        <span id="grammarScore">65%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%;"></div>
                    </div>

                    <div class="stat-item">
                        <span>ËØçÊ±áÈáè</span>
                        <span id="vocabScore">1,250 ËØç</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 45%;"></div>
                    </div>

                    <div class="stat-item">
                        <span>ÊñáÂåñÁêÜËß£</span>
                        <span id="cultureScore">40%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 40%;"></div>
                    </div>

                    <div class="stat-item">
                        <span>‰ªäÊó•Â≠¶‰π†Êó∂Èó¥</span>
                        <span id="todayTime">45 ÂàÜÈíü</span>
                    </div>
                </div>

                <div class="achievements">
                    <h3><i class="fas fa-trophy"></i> ÊàêÂ∞±Á≥ªÁªü</h3>
                    <div class="achievement-item unlocked">
                        <div class="achievement-icon">üèÜ</div>
                        <div>
                            <strong>ÂàùÂ≠¶ËÄÖ</strong><br>
                            <small>ÂÆåÊàêÁ¨¨‰∏ÄÊ¨°ÂØπËØù</small>
                        </div>
                    </div>
                    <div class="achievement-item unlocked">
                        <div class="achievement-icon">üìö</div>
                        <div>
                            <strong>ËØçÊ±áÂ≠¶ËÄÖ</strong><br>
                            <small>Â≠¶‰ºö100‰∏™ÂçïËØç</small>
                        </div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-icon">üéå</div>
                        <div>
                            <strong>ÊñáÂåñ‰∏ìÂÆ∂</strong><br>
                            <small>ÂÆåÊàê10‰∏™ÊñáÂåñ‰∏ªÈ¢ò</small>
                        </div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-icon">ü•á</div>
                        <div>
                            <strong>JLPTÊåëÊàòËÄÖ</strong><br>
                            <small>ÈÄöËøáÊ®°ÊãüËÄÉËØï</small>
                        </div>
                    </div>
                </div>

                <div class="novel-creation">
                    <h3><i class="fas fa-feather-alt"></i> Âçè‰ΩúÂ∞èËØ¥</h3>
                    <div class="novel-controls">
                        <button class="novel-btn" onclick="startNovelBrainstorm()">ÂºÄÂßãÂàõ‰Ωú</button>
                        <button class="novel-btn" onclick="viewNovelHistory()">Êü•ÁúãÂéÜÂè≤</button>
                    </div>
                    <div class="novel-progress" id="novelProgress">
                        <p><strong>ÂΩìÂâç‰∏ªÈ¢òÔºö</strong>ÈÉΩÂ∏ÇÂ•áÂπªÂÜíÈô©</p>
                        <p><strong>ÂèÇ‰∏éÊô∫ËÉΩ‰ΩìÔºö</strong>Áî∞‰∏≠ÂÖàÁîü, Â∞èÁæé, Â±±Áî∞ÂÖàÁîü</p>
                        <p><strong>Âàõ‰ΩúËøõÂ∫¶Ôºö</strong>Á¨¨3Á´† - Á•ûÁßòÁöÑÂíñÂï°Â∫ó</p>
                        <hr style="margin: 10px 0;">
                        <p style="font-style: italic;">"Âú®Ê∂©Ë∞∑ÁöÑÂ∞èÂ∑∑Ê∑±Â§ÑÔºåÈöêËóèÁùÄ‰∏ÄÂÆ∂Âè™Âú®Èõ®Â§úÊâç‰ºöÂá∫Áé∞ÁöÑÂíñÂï°Â∫ó..."</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Êô∫ËÉΩ‰ΩìÂàõÂª∫Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="agentCreatorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> ÂàõÂª∫Ëá™ÂÆö‰πâÊô∫ËÉΩ‰Ωì</h3>
                <button class="close-btn" onclick="closeModal('agentCreatorModal')">&times;</button>
            </div>

            <form id="agentCreatorForm">
                <div class="form-group">
                    <label>Êô∫ËÉΩ‰ΩìÂêçÁß∞</label>
                    <input type="text" id="agentName" placeholder="‰æãÂ¶Ç: Ê®±Ëä±ËÄÅÂ∏à" required>
                </div>

                <div class="form-group">
                    <label>ËßíËâ≤ËÆæÂÆö</label>
                    <textarea id="agentRole" placeholder="‰æãÂ¶Ç: Ê∏©ÊüîÁöÑÂä®Êº´ÊñáÂåñ‰∏ìÂÆ∂ÔºåÂñúÊ¨¢Áî®Âä®Êº´‰æãÂ≠êÊïôÂ≠¶"></textarea>
                </div>

                <div class="form-group">
                    <label>‰∏ì‰∏öÈ¢ÜÂüü</label>
                    <select id="agentExpertise" multiple>
                        <option value="grammar">ËØ≠Ê≥ï</option>
                        <option value="vocabulary">ËØçÊ±á</option>
                        <option value="culture">ÊñáÂåñ</option>
                        <option value="anime">Âä®Êº´</option>
                        <option value="business">ÂïÜÂä°</option>
                        <option value="literature">ÊñáÂ≠¶</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ÊÄßÊ†ºÁâπÂæÅË∞ÉËäÇ</label>
                    <div class="personality-sliders">
                        <div class="slider-group">
                            <label>‰∏•Ë∞®Á®ãÂ∫¶</label>
                            <input type="range" class="slider" id="strictness" min="1" max="10" value="5">
                            <div class="slider-value">5/10</div>
                        </div>
                        <div class="slider-group">
                            <label>ÂπΩÈªòÊÑü</label>
                            <input type="range" class="slider" id="humor" min="1" max="10" value="5">
                            <div class="slider-value">5/10</div>
                        </div>
                        <div class="slider-group">
                            <label>ËÄêÂøÉÂ∫¶</label>
                            <input type="range" class="slider" id="patience" min="1" max="10" value="7">
                            <div class="slider-value">7/10</div>
                        </div>
                        <div class="slider-group">
                            <label>ÂàõÈÄ†Âäõ</label>
                            <input type="range" class="slider" id="creativity" min="1" max="10" value="6">
                            <div class="slider-value">6/10</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ËØ¥ËØùÈ£éÊ†º</label>
                    <select id="speakingStyle">
                        <option value="formal">Ê≠£Âºè</option>
                        <option value="casual">ÈöèÊÑè</option>
                        <option value="friendly">ÂèãÂ•Ω</option>
                        <option value="professional">‰∏ì‰∏ö</option>
                        <option value="playful">Ê¥ªÊ≥º</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Â§¥ÂÉèË°®ÊÉÖ</label>
                    <select id="agentAvatar">
                        <option value="üë©‚Äçüè´">üë©‚Äçüè´ Â•≥ËÄÅÂ∏à</option>
                        <option value="üë®‚Äçüè´">üë®‚Äçüè´ Áî∑ËÄÅÂ∏à</option>
                        <option value="üë©‚Äçüéì">üë©‚Äçüéì Â•≥Â≠¶Áîü</option>
                        <option value="üë®‚Äçüéì">üë®‚Äçüéì Áî∑Â≠¶Áîü</option>
                        <option value="üßë‚Äçüíº">üßë‚Äçüíº ÂïÜÂä°‰∫∫Â£´</option>
                        <option value="üë©‚Äçüé®">üë©‚Äçüé® Ëâ∫ÊúØÂÆ∂</option>
                        <option value="üßô‚Äç‚ôÄÔ∏è">üßô‚Äç‚ôÄÔ∏è Êô∫ËÄÖ</option>
                        <option value="ü§ñ">ü§ñ AIÂä©Êâã</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%;">
                    <i class="fas fa-plus"></i> ÂàõÂª∫Êô∫ËÉΩ‰Ωì
                </button>
            </form>
        </div>
    </div>

    <!-- Âú∫ÊôØÁºñËæëÂô®Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="sceneEditorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> ÁºñËæëÂ≠¶‰π†Âú∫ÊôØ</h3>
                <button class="close-btn" onclick="closeModal('sceneEditorModal')">&times;</button>
            </div>

            <form id="sceneEditorForm">
                <div class="form-group">
                    <label>Âú∫ÊôØÂêçÁß∞</label>
                    <input type="text" id="sceneName" placeholder="‰æãÂ¶Ç: ‰∏ú‰∫¨ÂíñÂï°Â∫ó" required>
                </div>

                <div class="form-group">
                    <label>Âú∫ÊôØÊèèËø∞</label>
                    <textarea id="sceneDescription" placeholder="ËØ¶ÁªÜÊèèËø∞Ëøô‰∏™Âú∫ÊôØÁöÑÁéØÂ¢É„ÄÅÊ∞õÂõ¥ÂíåËÉåÊôØ..."></textarea>
                </div>

                <div class="form-group">
                    <label>Â≠¶‰π†ÁõÆÊ†á</label>
                    <textarea id="learningObjectives" placeholder="Ëøô‰∏™Âú∫ÊôØ‰∏ªË¶ÅÂ∏ÆÂä©Â≠¶‰π†‰ªÄ‰πàÂÜÖÂÆπÔºü"></textarea>
                </div>

                <div class="form-group">
                    <label>ÈöæÂ∫¶Á∫ßÂà´</label>
                    <select id="sceneDifficulty">
                        <option value="beginner">ÂàùÁ∫ß</option>
                        <option value="intermediate">‰∏≠Á∫ß</option>
                        <option value="advanced">È´òÁ∫ß</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Êé®ËçêÊô∫ËÉΩ‰Ωì</label>
                    <select id="recommendedAgents" multiple>
                        <option value="tanaka">Áî∞‰∏≠ÂÖàÁîü</option>
                        <option value="koumi">Â∞èÁæé</option>
                        <option value="ai">„Ç¢„Ç§</option>
                        <option value="yamada">Â±±Áî∞ÂÖàÁîü</option>
                        <option value="sato">‰ΩêËó§ÊïôÁªÉ</option>
                        <option value="membot">ËÆ∞ÂøÜÁÆ°ÂÆ∂</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Âú∫ÊôØËßÑÂàô</label>
                    <textarea id="sceneRules" placeholder="Âú®Ëøô‰∏™Âú∫ÊôØ‰∏≠ÁöÑÁâπÊÆäËßÑÂàôÊàñÈôêÂà∂..."></textarea>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> ‰øùÂ≠òÂú∫ÊôØ
                </button>
            </form>
        </div>
    </div>

    <!-- Â∞èËØ¥Âàõ‰ΩúÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="novelModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-feather-alt"></i> Âçè‰ΩúÂ∞èËØ¥Âàõ‰Ωú</h3>
                <button class="close-btn" onclick="closeModal('novelModal')">&times;</button>
            </div>

            <div id="novelContent">
                <div class="form-group">
                    <label>ÈÄâÊã©Âàõ‰Ωú‰∏ªÈ¢ò</label>
                    <select id="novelTheme">
                        <option value="urban_fantasy">ÈÉΩÂ∏ÇÂ•áÂπª</option>
                        <option value="school_life">Ê†°Âõ≠ÁîüÊ¥ª</option>
                        <option value="historical">ÂéÜÂè≤Ââß</option>
                        <option value="sci_fi">ÁßëÂπªÊú™Êù•</option>
                        <option value="romance">Êµ™Êº´Áà±ÊÉÖ</option>
                        <option value="mystery">ÊÇ¨ÁñëÊé®ÁêÜ</option>
                    </select>
                </div>

                <div class="collaboration-panel" style="margin-bottom: 20px;">
                    <div class="collaboration-status">
                        <strong>ÂèÇ‰∏éÊô∫ËÉΩ‰Ωì</strong>
                        <button class="btn-primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="startBrainstorm()">
                            ÂºÄÂßãÂ§¥ËÑëÈ£éÊö¥
                        </button>
                    </div>
                    <div class="agent-participation">
                        <span class="participant-badge">Áî∞‰∏≠ÂÖàÁîü (ÊÉÖËäÇËÆæËÆ°)</span>
                        <span class="participant-badge">Â∞èÁæé (ÂØπËØùÊ∂¶Ëâ≤)</span>
                        <span class="participant-badge">Â±±Áî∞ÂÖàÁîü (ÊñáÂåñËÉåÊôØ)</span>
                    </div>
                </div>

                <div id="novelWorkspace" style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-height: 400px; overflow-y: auto;">
                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);">üë®‚Äçüè´</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>Áî∞‰∏≠ÂÖàÁîü</strong>
                                <span>ÂàõÊÑèÊûÑÊÄù</span>
                            </div>
                            <div>ÊàëÂª∫ËÆÆÊàë‰ª¨Âàõ‰Ωú‰∏Ä‰∏™ÂÖ≥‰∫éÊó∂Á©∫Á©øË∂äÁöÑÊïÖ‰∫ã„ÄÇ‰∏ªËßíÊòØ‰∏ÄÂêçÁé∞‰ª£ÁöÑÊó•ËØ≠Â≠¶ÁîüÔºåÊÑèÂ§ñÁ©øË∂äÂà∞‰∫ÜÊ±üÊà∑Êó∂‰ª£...</div>
                        </div>
                    </div>

                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);">üëß</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>Â∞èÁæé</strong>
                                <span>ËßíËâ≤ËÆæËÆ°</span>
                            </div>
                            <div>ÂìáÔºÅËøô‰∏™ÊÉ≥Ê≥ïÂ§™Ê£í‰∫ÜÔºÅ‰∏ªËßíÂèØ‰ª•ÊòØ‰∏™Áà±Â•ΩÂéÜÂè≤ÁöÑÂ•≥Â≠©Â≠êÔºåÂêçÂ≠óÂè´ÁæéÂí≤„ÄÇÂ•πÂú®Á©øË∂äÂêéÈÅáÂà∞‰∏Ä‰∏™Ê≠¶Â£´...</div>
                        </div>
                    </div>

                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);">üéå</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>Â±±Áî∞ÂÖàÁîü</strong>
                                <span>ÂéÜÂè≤ËÉåÊôØ</span>
                            </div>
                            <div>ÂæàÂ•ΩÁöÑËÆæÂÆöÔºÅÊàë‰ª¨ÂèØ‰ª•ËÆæÂÆöÂú®Âæ∑Â∑ùÂπïÂ∫úÂêéÊúüÔºåÈÇ£Êó∂Ê≠£ÂÄºÂºÄÂõΩÂâçÂ§ïÔºåÁ§æ‰ºöÂèòÈù©Âç≥Â∞ÜÊù•‰∏¥ÔºåËøôÊ†∑ËÉΩÂàõÈÄ†ÂæàÂ§öÊàèÂâßÂÜ≤Á™Å...</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="continueWriting()" style="flex: 1;">
                        <i class="fas fa-pen"></i> ÁªßÁª≠Âàõ‰Ωú
                    </button>
                    <button class="btn-primary" onclick="exportNovel()" style="flex: 1;">
                        <i class="fas fa-download"></i> ÂØºÂá∫Â∞èËØ¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁü•Á≥ªÁªü -->
    <div id="notification" class="notification"></div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentAgents = new Set(['tanaka']);
        let chatHistory = [];
        let isThinking = false;
        let currentScene = 'grammar';
        let voiceRecognition = null;
        let learningStats = {
            grammar: 65,
            vocabulary: 1250,
            culture: 40,
            todayTime: 45
        };

        // Êñ∞Â¢ûÔºöÂêéÁ´ØAPIÈÖçÁΩÆ
        const API_BASE_URL = 'http://localhost:8000';
        let backendConnected = false;

        // Êô∫ËÉΩ‰ΩìÈÖçÁΩÆ
        const agents = {
            tanaka: {
                name: 'Áî∞‰∏≠ÂÖàÁîü',
                role: 'ËØ≠Ê≥ï‰∏ìÂÆ∂',
                avatar: 'üë®‚Äçüè´',
                personality: { strict: 8, patient: 6, humor: 3 },
                expertise: ['grammar', 'formal_language'],
                speaking_style: 'formal',
                emotions: ['üòê', 'ü§î', 'üò§', 'üòä', 'üëç']
            },
            koumi: {
                name: 'Â∞èÁæé',
                role: 'ÂØπËØù‰ºô‰º¥',
                avatar: 'üëß',
                personality: { strict: 2, patient: 9, humor: 8 },
                expertise: ['conversation', 'casual_language', 'youth_culture'],
                speaking_style: 'casual',
                emotions: ['üòä', 'üòÑ', 'üòç', 'ü§ó', 'üòâ']
            },
            ai: {
                name: '„Ç¢„Ç§',
                role: 'ÂàÜÊûêÂ∏à',
                avatar: 'ü§ñ',
                personality: { strict: 5, patient: 7, humor: 4 },
                expertise: ['analysis', 'personalization', 'data'],
                speaking_style: 'professional',
                emotions: ['ü§î', 'üí°', 'üìä', 'üîç', '‚ö°']
            },
            yamada: {
                name: 'Â±±Áî∞ÂÖàÁîü',
                role: 'ÊñáÂåñ‰∏ìÂÆ∂',
                avatar: 'üéå',
                personality: { strict: 4, patient: 8, humor: 7 },
                expertise: ['culture', 'history', 'traditions'],
                speaking_style: 'storytelling',
                emotions: ['üòå', 'üéé', '‚õ©Ô∏è', 'üçÉ', 'üìø']
            },
            sato: {
                name: '‰ΩêËó§ÊïôÁªÉ',
                role: 'ËÄÉËØï‰∏ìÂÆ∂',
                avatar: 'üéØ',
                personality: { strict: 9, patient: 5, humor: 2 },
                expertise: ['jlpt', 'testing', 'strategy'],
                speaking_style: 'motivational',
                emotions: ['üò§', 'üí™', 'üèÜ', '‚ö°', 'üî•']
            },
            membot: {
                name: 'ËÆ∞ÂøÜÁÆ°ÂÆ∂',
                role: 'Â≠¶‰π†ËÆ∞ÂΩï',
                avatar: 'üß†',
                personality: { strict: 6, patient: 10, humor: 5 },
                expertise: ['memory', 'progress', 'scheduling'],
                speaking_style: 'systematic',
                emotions: ['üß†', 'üìö', '‚è∞', 'üíæ', 'üìà']
            }
        };

        // Âú∫ÊôØÈÖçÁΩÆ
        const scenes = {
            grammar: {
                name: 'ËØ≠Ê≥ïÂ≠¶‰π†',
                description: '‰∏ìÊ≥®‰∫éÊó•ËØ≠ËØ≠Ê≥ïËßÑÂàôÁöÑÂ≠¶‰π†ÂíåÁªÉ‰π†',
                recommended_agents: ['tanaka', 'ai', 'membot'],
                difficulty: 'all_levels'
            },
            conversation: {
                name: 'Êó•Â∏∏ÂØπËØù',
                description: 'ÁªÉ‰π†Êó•Â∏∏ÁîüÊ¥ª‰∏≠ÁöÑÂØπËØùÊäÄÂ∑ß',
                recommended_agents: ['koumi', 'yamada', 'ai'],
                difficulty: 'beginner_intermediate'
            },
            restaurant: {
                name: 'È§êÂéÖÂú∫ÊôØ',
                description: 'Âú®Êó•ÂºèÈ§êÂéÖÁÇπÈ§êÂíåÁî®È§êÁöÑÊÉÖÂ¢ÉÂØπËØù',
                recommended_agents: ['koumi', 'yamada'],
                difficulty: 'beginner'
            },
            shopping: {
                name: 'Ë¥≠Áâ©Âú∫ÊôØ',
                description: 'Âú®ÂïÜÂ∫óË¥≠Áâ©Êó∂ÁöÑÊó•ËØ≠Ë°®Ëææ',
                recommended_agents: ['koumi', 'ai'],
                difficulty: 'beginner'
            },
            interview: {
                name: 'Èù¢ËØïÂáÜÂ§á',
                description: 'ÂïÜÂä°Êó•ËØ≠ÂíåÈù¢ËØïÊäÄÂ∑ßËÆ≠ÁªÉ',
                recommended_agents: ['sato', 'tanaka', 'ai'],
                difficulty: 'advanced'
            },
            culture: {
                name: 'ÊñáÂåñÊé¢Á¥¢',
                description: 'Ê∑±ÂÖ•‰∫ÜËß£Êó•Êú¨ÊñáÂåñÂíåÂéÜÂè≤',
                recommended_agents: ['yamada', 'koumi'],
                difficulty: 'all_levels'
            },
            jlpt: {
                name: 'JLPTËÄÉËØï',
                description: 'ÈíàÂØπJLPTËÄÉËØïÁöÑ‰∏ìÈó®ËÆ≠ÁªÉ',
                recommended_agents: ['sato', 'tanaka', 'membot'],
                difficulty: 'all_levels'
            }
        };

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendConnection();
            initializeEventListeners();
            initializeVoiceRecognition();
            startPeriodicUpdates();
        });

        // Êñ∞Â¢ûÔºöÊ£ÄÊü•ÂêéÁ´ØËøûÊé•
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (response.ok) {
                    backendConnected = true;
                    updateBackendStatus(true);
                    showNotification('‚úÖ ÂêéÁ´ØËøûÊé•ÊàêÂäüÔºåÁúüÂÆûAIÂØπËØùÂ∑≤ÂêØÁî®ÔºÅ', 'success');
                } else {
                    throw new Error('Backend not responding');
                }
            } catch (error) {
                backendConnected = false;
                updateBackendStatus(false);
                showNotification('‚ö†Ô∏è ÂêéÁ´ØÊú™ËøûÊé•Ôºå‰ΩøÁî®Ê®°ÊãüÂØπËØùÊ®°Âºè', 'warning');
                console.error('Backend connection failed:', error);
            }
        }

        // Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÂêéÁ´ØÁä∂ÊÄÅÊòæÁ§∫
        function updateBackendStatus(isOnline) {
            const statusElement = document.getElementById('backendStatus');
            if (isOnline) {
                statusElement.textContent = 'üü¢ AIÂú®Á∫ø';
                statusElement.className = 'backend-status status-online';
            } else {
                statusElement.textContent = 'üü° Ê®°ÊãüÊ®°Âºè';
                statusElement.className = 'backend-status status-offline';
            }
        }

        // Êñ∞Â¢ûÔºöÈ°µÈù¢ÂØºËà™ÂáΩÊï∞
        function navigateToPage(page) {
            switch(page) {
                case 'chat':
                    // Â∑≤ÁªèÂú®ËÅäÂ§©È°µÈù¢ÔºåÊªöÂä®Âà∞ËÅäÂ§©Âå∫Âüü
                    document.querySelector('.chat-area').scrollIntoView({ behavior: 'smooth' });
                    break;
                default:
                    showNotification('È°µÈù¢Ë∑≥ËΩ¨ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
            }
        }

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®ÂàùÂßãÂåñ
        function initializeEventListeners() {
            // Êô∫ËÉΩ‰ΩìÂç°ÁâáÁÇπÂáª
            document.querySelectorAll('.agent-card').forEach(card => {
                card.addEventListener('click', function() {
                    const agentId = this.dataset.agent;
                    toggleAgent(agentId);
                });
            });

            // Âú∫ÊôØÈÄâÊã©
            document.getElementById('sceneSelect').addEventListener('change', function() {
                changeScene(this.value);
            });

            // ÂèëÈÄÅÊ∂àÊÅØ
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Ë°®ÂçïÊèê‰∫§
            document.getElementById('agentCreatorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createCustomAgent();
            });

            document.getElementById('sceneEditorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCustomScene();
            });

            // ÊªëÂùóÊõ¥Êñ∞
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const valueDisplay = this.parentNode.querySelector('.slider-value');
                    valueDisplay.textContent = this.value + '/10';
                });
            });
        }

        // ÂàáÊç¢Êô∫ËÉΩ‰ΩìÊøÄÊ¥ªÁä∂ÊÄÅ
        function toggleAgent(agentId) {
            const card = document.querySelector(`.agent-card[data-agent="${agentId}"]`);

            if (currentAgents.has(agentId)) {
                if (currentAgents.size > 1) {
                    currentAgents.delete(agentId);
                    card.classList.remove('active');
                    showNotification(`${agents[agentId].name} Â∑≤Á¶ªÂºÄÂØπËØù`, 'info');
                } else {
                    showNotification('Ëá≥Â∞ëÈúÄË¶Å‰øùÊåÅ‰∏Ä‰∏™Êô∫ËÉΩ‰ΩìÂú®Á∫øÔºÅ', 'warning');
                    return;
                }
            } else {
                currentAgents.add(agentId);
                card.classList.add('active');
                showNotification(`${agents[agentId].name} Âä†ÂÖ•‰∫ÜÂØπËØù`, 'success');

                // Êô∫ËÉΩ‰ΩìÂä†ÂÖ•Êó∂ÁöÑÊ¨¢ËøéÊ∂àÊÅØ
                setTimeout(() => {
                    const joinMessage = getAgentJoinMessage(agentId);
                    addMessage(agentId, joinMessage);
                }, 500);
            }

            updateActiveAgentsDisplay();
        }

        // Ëé∑ÂèñÊô∫ËÉΩ‰ΩìÂä†ÂÖ•Ê∂àÊÅØ
        function getAgentJoinMessage(agentId) {
            const joinMessages = {
                tanaka: "Â§±Á§º„Åó„Åæ„Åô„ÄÇÁî∞‰∏≠„Åß„Åô„ÄÇÁöÜ„Åï„Çì„ÅÆÊó•Êú¨Ë™ûÂ≠¶Áøí„Çí„ÅäÊâã‰ºù„ÅÑ„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇ",
                koumi: "„ÇÑ„Å£„Åª„ÉºÔºÅÂ∞èÁæé„Å†„ÇàÔΩûÔºÅ‰∏ÄÁ∑í„Å´Ê•Ω„Åó„ÅèÊó•Êú¨Ë™û„ÇíÁ∑¥Áøí„Åó„Çà„ÅÜÔºÅ",
                ai: "„Åì„Çì„Å´„Å°„ÅØ„ÄÅ„Ç¢„Ç§„Åß„Åô„ÄÇ„Éá„Éº„ÇøÂàÜÊûê„ÇíÈÄö„Åò„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂ≠¶Áøí„Çí„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ",
                yamada: "„Åì„Çì„Å´„Å°„ÅØ„ÄÇÂ±±Áî∞„Å®Áî≥„Åó„Åæ„Åô„ÄÇÊó•Êú¨„ÅÆÊñáÂåñ„Å´„Å§„ÅÑ„Å¶„ÄÅËâ≤„ÄÖ„Å®„ÅäË©±„Åó„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                sato: "‰ΩêËó§„Å†ÔºÅË©¶È®ìÂêàÊ†º„ÇíÁõÆÊåá„Åó„Å¶„ÄÅ„Åó„Å£„Åã„Çä„Å®Á∑¥Áøí„Åô„Çã„ÅûÔºÅ",
                membot: "Â≠¶ÁøíË®òÈå≤„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï„ÄÇ„ÅÇ„Å™„Åü„ÅÆÈÄ≤Ê≠©„ÇíË®òÈå≤„ÉªÂàÜÊûê„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ"
            };
            return joinMessages[agentId] || `${agents[agentId].name}„ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü„ÄÇ`;
        }

        // Êõ¥Êñ∞Ê¥ªË∑ÉÊô∫ËÉΩ‰ΩìÊòæÁ§∫
        function updateActiveAgentsDisplay() {
            const countElement = document.getElementById('activeAgentsCount');
            const listElement = document.getElementById('activeAgentsList');

            countElement.textContent = `${currentAgents.size} ‰∏™Êô∫ËÉΩ‰ΩìÊ¥ªË∑É`;

            listElement.innerHTML = '';
            currentAgents.forEach(agentId => {
                const badge = document.createElement('span');
                badge.className = 'participant-badge';
                badge.textContent = agents[agentId].name;
                listElement.appendChild(badge);
            });
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMessage('user', message);
            input.value = '';

            // ÊòæÁ§∫ÊÄùËÄÉÊåáÁ§∫Âô®
            showThinkingIndicator();

            // Â§ÑÁêÜÊ∂àÊÅØ
            setTimeout(() => {
                processMessage(message);
            }, 1000);
        }

        // ‰øÆÊîπÔºöÂ§ÑÁêÜÊ∂àÊÅØÂπ∂ÁîüÊàêÊô∫ËÉΩ‰ΩìÂõûÂ∫î
        async function processMessage(userMessage) {
            if (backendConnected) {
                // ÁúüÂÆûAPIË∞ÉÁî®
                await processMessageWithAPI(userMessage);
            } else {
                // Ê®°ÊãüÂìçÂ∫î
                await processMessageMock(userMessage);
            }
        }


        // ‚úÖ ÊåâÊñπÊ°àAÔºöÂâçÁ´ØÊîπÁî® message Â≠óÊÆµÔºõscene_context ‰øùËØÅÊòØÂ≠óÁ¨¶‰∏≤
        async function processMessageWithAPI(userMessage) {
            try {
                const activeAgentsList = Array.from(currentAgents);

                // ÈÄê‰∏™Êô∫ËÉΩ‰ΩìÂπ∂Ë°åËØ∑Ê±Ç + ÈÄê‰∏™Âª∂ËøüÂ±ïÁ§∫
                for (const [idx, agentId] of activeAgentsList.entries()) {
                    // ÊûÑÈÄ†Ê≠£Á°ÆÁöÑËØ∑Ê±Ç‰ΩìÔºàÂêéÁ´ØË¶ÅÊ±Ç message + scene_context ‰∏∫Â≠óÁ¨¶‰∏≤Ôºâ
                    const requestBody = {
                        message: String(userMessage), // ‚ö†Ô∏è ÂøÖÈ°ªÂè´ message
                        user_id: "demo_user",
                        session_id: "session_" + Date.now(),
                        agent_name: agents[agentId].name,
                        scene_context:
                            (typeof currentScene === "string" && currentScene.trim() !== "")
                                ? currentScene
                                : "general" // Áªô‰∏™ÂÖúÂ∫ïÔºåÈÅøÂÖçÈùûÂ≠óÁ¨¶‰∏≤ÂØºËá¥ 422
                    };

                    // ÂèëÈÄÅËØ∑Ê±Ç
                    const response = await fetch(`${API_BASE_URL}/api/v1/chat/send`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json; charset=utf-8",
                            "Accept": "application/json"
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        // ÊàêÂäüÔºöËß£Êûê JSON
                        const data = await response.json();

                        // Âª∂ËøüÊòæÁ§∫ÂõûÂ∫î‰ª•Ê®°ÊãüÊÄùËÄÉÊó∂Èó¥ÔºàÊåâÂ∫èÊéíÈòüÔºâ
                        setTimeout(() => {
                            // 1) Êô∫ËÉΩ‰ΩìÂõûÂ§ç
                            addMessage(agentId, data.response || "Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïÂõûÁ≠î„ÄÇ");

                            // 2) Êõ¥Êñ∞ÊÉÖÁª™
                            updateAgentEmotion(agentId);

                            // 3) Â≠¶‰π†ÁÇπ
                            if (Array.isArray(data.learning_points) && data.learning_points.length > 0) {
                                showNotification(`üìö Â≠¶‰π†ÁÇπ: ${data.learning_points.join(", ")}`, "info");
                            }

                            // 4) Âª∫ËÆÆ
                            if (Array.isArray(data.suggestions) && data.suggestions.length > 0) {
                                showNotification(`üí° Âª∫ËÆÆ: ${data.suggestions.join(", ")}`, "success");
                            }
                        }, idx * 1000 + 500);

                    } else {
                        // Â§±Ë¥•ÔºöÂ∞ΩÈáèËß£ÊûêÂêéÁ´ØÈîôËØØÔºàJSON ‰ºòÂÖàÔºåÈÄÄÂõûÊñáÊú¨Ôºâ
                        let errorPayload;
                        try {
                            errorPayload = await response.clone().json();
                        } catch {
                            errorPayload = await response.text();
                        }
                        console.error("APIË∞ÉÁî®Â§±Ë¥•:", response.status, errorPayload);

                        // ÂõûÈÄÄÂà∞Ê®°ÊãüÂìçÂ∫î
                        setTimeout(() => {
                            const mockResponse = generateAgentResponse(agentId, userMessage);
                            addMessage(agentId, mockResponse + "\n\n*[APIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÂìçÂ∫î]*");
                            updateAgentEmotion(agentId);
                        }, idx * 1000 + 500);
                    }
                }

                // ÊâÄÊúâ‰ª£ÁêÜÊòæÁ§∫ÂÆåÂêéÔºåÊî∂Â∞æ
                setTimeout(() => {
                    hideThinkingIndicator?.();
                    updateLearningProgress?.();
                }, activeAgentsList.length * 1000 + 1000);

            } catch (error) {
                console.error("APIËØ∑Ê±ÇÈîôËØØ:", error);
                showNotification("ÁΩëÁªúÈîôËØØÔºåÂàáÊç¢Âà∞Ê®°ÊãüÊ®°Âºè", "warning");
                await processMessageMock(userMessage);
            }
        }

        // Êñ∞Â¢ûÔºöÊ®°ÊãüÂìçÂ∫îÂ§ÑÁêÜ
        async function processMessageMock(userMessage) {
            const responses = [];

            // Ê†πÊçÆÂΩìÂâçÂú∫ÊôØÂíåÊ¥ªË∑ÉÊô∫ËÉΩ‰ΩìÁîüÊàêÂõûÂ∫î
            currentAgents.forEach(agentId => {
                const response = generateAgentResponse(agentId, userMessage);
                responses.push({ agentId, response: response + "\n\n*[Ê®°ÊãüÂìçÂ∫î]*" });
            });

            // ÈöèÊú∫Âª∂ËøüÊòæÁ§∫ÂêÑÊô∫ËÉΩ‰ΩìÂõûÂ∫î
            responses.forEach((item, index) => {
                setTimeout(() => {
                    addMessage(item.agentId, item.response);
                    updateAgentEmotion(item.agentId);

                    if (index === responses.length - 1) {
                        hideThinkingIndicator();
                        updateLearningProgress();
                    }
                }, index * (500 + Math.random() * 1000));
            });
        }

        // ÁîüÊàêÊô∫ËÉΩ‰ΩìÂõûÂ∫î
        function generateAgentResponse(agentId, userMessage) {
            const agent = agents[agentId];
            const scene = scenes[currentScene];

            // Âü∫‰∫éÊô∫ËÉΩ‰ΩìÁ±ªÂûãÂíåÂú∫ÊôØÁîüÊàê‰∏çÂêåÂõûÂ∫î
            const responses = {
                tanaka: {
                    grammar: [
                        "ÊñáÊ≥ï„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ„Äå" + userMessage + "„Äç„ÅÆÊñáÊ≥ïÊßãÈÄ†„ÇíÂàÜÊûê„Åô„Çã„Å®...",
                        "„Åù„ÅÆË°®Áèæ„ÅØÊ≠£„Åó„ÅÑ„Åß„Åô„Åå„ÄÅ„Çà„ÇäËá™ÁÑ∂„Å™Ë®Ä„ÅÑÊñπ„ÇÇ„ÅÇ„Çä„Åæ„Åô„ÄÇ",
                        "Âä©Ë©û„ÅÆ‰Ωø„ÅÑÊñπ„Å´Ê≥®ÊÑè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æã„Åà„Å∞..."
                    ],
                    conversation: [
                        "‰∏ÅÂØßË™û„Çí‰Ωø„ÅÜÂ†¥Èù¢„Åß„ÅØ„ÄÅ„Åì„ÅÆ„Çà„ÅÜ„Å´Ë°®Áèæ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                        "Êó•Â∏∏‰ºöË©±„Åß„ÅØ„ÄÅ„ÇÇ„ÅÜÂ∞ë„Åó„Ç´„Ç∏„É•„Ç¢„É´„Å™Ë°®Áèæ„ÇÇ‰Ωø„Åà„Åæ„Åô„ÄÇ"
                    ]
                },
                koumi: {
                    conversation: [
                        "„ÅÇ„ÄÅ„Åù„ÇåÂàÜ„Åã„ÇãÔºÅÁßÅ„Åü„Å°„ÇÇ„Çà„Åè‰Ωø„ÅÜ„ÇàÔΩû",
                        "‰ªäÂ∫¶„ÅØÁßÅ„ÅåÁ≠î„Åà„ÇãÁï™„Å†„Å≠ÔºÅ„Åà„Éº„Å£„Å®...",
                        "„Åù„ÅÜ„ÅÑ„ÅÜÊôÇ„ÅØ„ÄÅ„Åì„Çì„Å™ÊÑü„Åò„ÅßË®Ä„ÅÜ„Å®Ëá™ÁÑ∂„Å†„ÇàÔºÅ"
                    ],
                    restaurant: [
                        "„É¨„Çπ„Éà„É©„É≥„Åß„ÅØ„Äå„Åô„Åø„Åæ„Åõ„Çì„Äç„Å£„Å¶Âëº„Å∂„ÅÆ„ÅåÊôÆÈÄö„Å†„ÇàÔºÅ",
                        "„É°„Éã„É•„Éº„ÇíË¶ã„Å™„Åå„Çâ„Äå„Åì„Çå„ÄÅ„Åä„ÅÑ„Åó„Åù„ÅÜÔºÅ„Äç„Å£„Å¶Ë®Ä„Åà„Çã„Å≠„ÄÇ"
                    ]
                },
                ai: [
                    "„Éá„Éº„ÇøÂàÜÊûê„Å´„Çà„Çã„Å®„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂ≠¶Áøí„Éë„Çø„Éº„É≥„ÅØ...",
                    "„Åì„ÅÆË°®Áèæ„ÅÆÁøíÂæóÂ∫¶„ÅØ78%„Åß„Åô„ÄÇÂæ©Áøí„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ",
                    "È°û‰ººË°®Áèæ„Å®„ÅÆÊØîËºÉÁµêÊûú„Çí„ÅäÁ§∫„Åó„Åó„Åæ„Åô„ÄÇ"
                ],
                yamada: {
                    culture: [
                        "„Åì„ÅÆË°®Áèæ„Å´„ÅØËààÂë≥Ê∑±„ÅÑÊñáÂåñÁöÑËÉåÊôØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
                        "Êó•Êú¨„Åß„ÅØÊòî„Åã„Çâ„ÄÅ„Åì„ÅÆ„Çà„ÅÜ„Å™Â†¥Èù¢„Åß...",
                        "Â≠£ÁØÄ„ÅÆÊå®Êã∂„ÅØÊó•Êú¨ÊñáÂåñ„ÅÆÈáçË¶Å„Å™Ë¶ÅÁ¥†„Åß„Åô„Å≠„ÄÇ"
                    ]
                },
                sato: {
                    jlpt: [
                        "JLPT N3„É¨„Éô„É´„ÅÆÈáçË¶ÅË°®Áèæ„Åß„ÅôÔºÅÂøÖ„ÅöË¶ö„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                        "Ë©¶È®ì„Åß„Çà„ÅèÂá∫„ÇãÊñáÊ≥ï„Éë„Çø„Éº„É≥„Åß„Åô„Å≠„ÄÇ",
                        "„Åì„ÅÆÂïèÈ°åÂΩ¢Âºè„ÅßÁ∑¥Áøí„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ"
                    ]
                },
                membot: [
                    "Â≠¶ÁøíË®òÈå≤„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ‰ªäÊó•„ÅÆÈÄ≤Ê≠©Áéá: +5%",
                    "„Åì„ÅÆÂçòË™û„ÅØ3ÂõûÁõÆ„ÅÆÂá∫Áèæ„Åß„Åô„ÄÇÂÆöÁùÄÂ∫¶„ÅåÂêë‰∏ä„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
                    "Âæ©Áøí„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË™øÊï¥„Åó„Åæ„Åó„Åü„ÄÇ"
                ]
            };

            // „Ç®„Éº„Ç∏„Çß„É≥„ÉàÂõ∫Êúâ„ÅÆÂõûÁ≠î„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰ΩøÁî®
            let agentResponses = responses[agentId];
            if (typeof agentResponses === 'object' && agentResponses[currentScene]) {
                agentResponses = agentResponses[currentScene];
            } else if (typeof agentResponses === 'object') {
                agentResponses = agentResponses.conversation || Object.values(agentResponses)[0];
            }

            // „É©„É≥„ÉÄ„É†„Å´ÂõûÁ≠î„ÇíÈÅ∏Êäû
            const randomResponse = agentResponses[Math.floor(Math.random() * agentResponses.length)];

            // ‰∏≠ÊñáÁøªËØë
            const translations = {
                "ÊñáÊ≥ï„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Çá„ÅÜ": "ËÆ©Êàë‰ª¨Á°ÆËÆ§‰∏Ä‰∏ãËØ≠Ê≥ï",
                "„Åù„ÅÆË°®Áèæ„ÅØÊ≠£„Åó„ÅÑ„Åß„Åô": "Ëøô‰∏™Ë°®ËææÊòØÊ≠£Á°ÆÁöÑ",
                "Âä©Ë©û„ÅÆ‰Ωø„ÅÑÊñπ„Å´Ê≥®ÊÑè": "ËØ∑Ê≥®ÊÑèÂä©ËØçÁöÑÁî®Ê≥ï",
                "„Éá„Éº„ÇøÂàÜÊûê„Å´„Çà„Çã„Å®": "Ê†πÊçÆÊï∞ÊçÆÂàÜÊûê",
                "Â≠¶ÁøíË®òÈå≤„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü": "Â∑≤Êõ¥Êñ∞Â≠¶‰π†ËÆ∞ÂΩï"
            };

            let translation = "";
            for (const [japanese, chinese] of Object.entries(translations)) {
                if (randomResponse.includes(japanese)) {
                    translation = `\n\n**‰∏≠ÊñáÊèêÁ§∫Ôºö** ${chinese}Áõ∏ÂÖ≥ÂÜÖÂÆπ...`;
                    break;
                }
            }

            return randomResponse + translation;
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©Âå∫Âüü
        function addMessage(senderId, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message' + (senderId === 'user' ? ' user' : '');

            let avatarContent, senderName, avatarStyle;

            if (senderId === 'user') {
                avatarContent = 'üë§';
                senderName = '‰Ω†';
                avatarStyle = 'background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);';
            } else {
                const agent = agents[senderId];
                avatarContent = agent.avatar;
                senderName = agent.name;
                avatarStyle = getAgentAvatarStyle(senderId);
            }

            messageDiv.innerHTML = `
                <div class="message-avatar" style="${avatarStyle}">${avatarContent}</div>
                <div class="message-content">
                    <div class="message-meta">
                        <strong>${senderName}</strong>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div>${content}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
            messageDiv.classList.add('bounce');
        }

        // Ëé∑ÂèñÊô∫ËÉΩ‰ΩìÂ§¥ÂÉèÊ†∑Âºè
        function getAgentAvatarStyle(agentId) {
            const styles = {
                tanaka: 'background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);',
                koumi: 'background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);',
                ai: 'background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);',
                yamada: 'background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);',
                sato: 'background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);',
                membot: 'background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);'
            };
            return styles[agentId] || styles.ai;
        }

        // Êõ¥Êñ∞Êô∫ËÉΩ‰ΩìÊÉÖÁª™
        function updateAgentEmotion(agentId) {
            const card = document.querySelector(`.agent-card[data-agent="${agentId}"]`);
            const emotionElement = card.querySelector('.agent-emotion');
            const emotions = agents[agentId].emotions;
            const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
            emotionElement.textContent = randomEmotion;
        }

        // ÊòæÁ§∫/ÈöêËóèÊÄùËÄÉÊåáÁ§∫Âô®
        function showThinkingIndicator() {
            document.getElementById('thinkingIndicator').classList.add('active');
            isThinking = true;
        }

        function hideThinkingIndicator() {
            document.getElementById('thinkingIndicator').classList.remove('active');
            isThinking = false;
        }

        // Âú∫ÊôØÂàáÊç¢
        function changeScene(sceneId) {
            currentScene = sceneId;
            const scene = scenes[sceneId];

            showNotification(`Âú∫ÊôØÂàáÊç¢Âà∞: ${scene.name}`, 'info');

            // Êé®ËçêÊô∫ËÉΩ‰Ωì
            if (scene.recommended_agents) {
                highlightRecommendedAgents(scene.recommended_agents);
            }

            // Ê∑ªÂä†Âú∫ÊôØËΩ¨Êç¢Ê∂àÊÅØ
            setTimeout(() => {
                addMessage('system', `Âú∫ÊôØÂ∑≤ÂàáÊç¢Âà∞Ôºö${scene.name}„ÄÇ${scene.description}`);
            }, 500);
        }

        // È´ò‰∫ÆÊé®ËçêÊô∫ËÉΩ‰Ωì
        function highlightRecommendedAgents(recommendedAgents) {
            document.querySelectorAll('.agent-card').forEach(card => {
                const agentId = card.dataset.agent;
                if (recommendedAgents.includes(agentId)) {
                    card.style.border = '2px solid #48bb78';
                    card.style.boxShadow = '0 0 15px rgba(72, 187, 120, 0.3)';
                    setTimeout(() => {
                        card.style.border = '';
                        card.style.boxShadow = '';
                    }, 3000);
                }
            });
        }

        // Âø´ÈÄüÊìç‰ΩúÂäüËÉΩ
        function startGrammarCheck() {
            changeScene('grammar');
            if (!currentAgents.has('tanaka')) {
                toggleAgent('tanaka');
            }
            addMessage('tanaka', 'Ë™ûÊ≥ï„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇÊñáÁ´†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n**‰∏≠ÊñáÊèêÁ§∫Ôºö** ËØ∑ËæìÂÖ•ÈúÄË¶ÅÊ£ÄÊü•ËØ≠Ê≥ïÁöÑÊó•ËØ≠Âè•Â≠ê„ÄÇ');
        }

        function startVocabExpansion() {
            if (!currentAgents.has('koumi')) {
                toggleAgent('koumi');
            }
            if (!currentAgents.has('ai')) {
                toggleAgent('ai');
            }
            addMessage('koumi', 'Ë™ûÂΩô„ÇíÂ¢ó„ÇÑ„Åù„ÅÜÔºÅ‰Ωï„ÅãÂçòË™û„ÇíÊïô„Åà„Å¶ÔΩû\n\n**‰∏≠ÊñáÊèêÁ§∫Ôºö** ËØ¥Âá∫‰∏Ä‰∏™Êó•ËØ≠ÂçïËØçÔºåÊàë‰ª¨Êù•Êâ©Â±ïÁõ∏ÂÖ≥ËØçÊ±áÔºÅ');
        }

        function startCulturalContext() {
            changeScene('culture');
            if (!currentAgents.has('yamada')) {
                toggleAgent('yamada');
            }
            addMessage('yamada', 'Êó•Êú¨„ÅÆÊñáÂåñ„Å´„Å§„ÅÑ„Å¶‰Ωï„ÅãËÅû„Åç„Åü„ÅÑ„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü\n\n**‰∏≠ÊñáÊèêÁ§∫Ôºö** Êúâ‰ªÄ‰πàÊÉ≥‰∫ÜËß£ÁöÑÊó•Êú¨ÊñáÂåñÂêóÔºü');
        }

        function startJLPTPrep() {
            changeScene('jlpt');
            if (!currentAgents.has('sato')) {
                toggleAgent('sato');
            }
            if (!currentAgents.has('membot')) {
                toggleAgent('membot');
            }
            addMessage('sato', 'JLPTÂØæÁ≠ñ„ÇíÂßã„ÇÅ„Çà„ÅÜÔºÅÁõÆÊ®ô„É¨„Éô„É´„ÅØ‰ΩïÁ¥ö„Åß„Åô„ÅãÔºü\n\n**‰∏≠ÊñáÊèêÁ§∫Ôºö** ÂºÄÂßãJLPTÂ§áËÄÉÔºÅÁõÆÊ†áÊòØÂá†Á∫ßÔºü');
        }

        // ËØ≠Èü≥ËæìÂÖ•ÂäüËÉΩ
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();
                voiceRecognition.lang = 'ja-JP';
                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = false;

                voiceRecognition.onresult = function(event) {
                    const result = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = result;
                    showNotification('ËØ≠Èü≥ËØÜÂà´ÂÆåÊàêÔºÅ', 'success');
                };

                voiceRecognition.onerror = function(event) {
                    showNotification('ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'warning');
                };
            }
        }

        function startVoiceInput() {
            if (typeof VoiceInputManager !== 'undefined') {
                if (!window.voiceManagerInstance) {
                    window.voiceManagerInstance = new VoiceInputManager();
                }
                window.voiceManagerInstance.startVoiceInput();
            } else {
                // ÂéüÊù•ÁöÑÁÆÄÂçïÂÆûÁé∞‰Ωú‰∏∫ÂêéÂ§á
                if (voiceRecognition) {
                    voiceRecognition.start();
                    showNotification('Ê≠£Âú®ÁõëÂê¨ËØ≠Èü≥ËæìÂÖ•...', 'info');
                    // ... ‰Ω†ÁöÑÂéüÂßã‰ª£Á†Å
                } else {
                    showNotification('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÂäüËÉΩ', 'warning');
                }
            }
        }

        // Ê®°ÊÄÅÊ°ÜÊéßÂà∂
        function openAgentCreator() {
            document.getElementById('agentCreatorModal').style.display = 'block';
        }

        function openSceneEditor() {
            document.getElementById('sceneEditorModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ÂàõÂª∫Ëá™ÂÆö‰πâÊô∫ËÉΩ‰Ωì
        function createCustomAgent() {
            const formData = {
                name: document.getElementById('agentName').value,
                role: document.getElementById('agentRole').value,
                expertise: Array.from(document.getElementById('agentExpertise').selectedOptions).map(o => o.value),
                personality: {
                    strictness: document.getElementById('strictness').value,
                    humor: document.getElementById('humor').value,
                    patience: document.getElementById('patience').value,
                    creativity: document.getElementById('creativity').value
                },
                speakingStyle: document.getElementById('speakingStyle').value,
                avatar: document.getElementById('agentAvatar').value
            };

            // ÁîüÊàêÂîØ‰∏ÄID
            const customId = 'custom_' + Date.now();

            // Ê∑ªÂä†Âà∞Êô∫ËÉΩ‰ΩìÂàóË°®
            agents[customId] = {
                name: formData.name,
                role: formData.role,
                avatar: formData.avatar,
                personality: formData.personality,
                expertise: formData.expertise,
                speaking_style: formData.speakingStyle,
                emotions: ['üòä', 'ü§î', 'üí°', 'üëç', 'üéâ'],
                isCustom: true
            };

            // ÂàõÂª∫Êô∫ËÉΩ‰ΩìÂç°Áâá
            createAgentCard(customId, agents[customId]);

            closeModal('agentCreatorModal');
            showNotification(`Ëá™ÂÆö‰πâÊô∫ËÉΩ‰Ωì ${formData.name} ÂàõÂª∫ÊàêÂäüÔºÅ`, 'success');

            // ÈáçÁΩÆË°®Âçï
            document.getElementById('agentCreatorForm').reset();
            document.querySelectorAll('.slider-value').forEach(el => el.textContent = '5/10');
        }

        // ÂàõÂª∫Êô∫ËÉΩ‰ΩìÂç°Áâá
        function createAgentCard(agentId, agentData) {
            const agentGrid = document.querySelector('.agent-grid');
            const agentCard = document.createElement('div');
            agentCard.className = 'agent-card';
            agentCard.dataset.agent = agentId;

            agentCard.innerHTML = `
                <div class="agent-emotion">üòä</div>
                <div class="agent-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">${agentData.avatar}</div>
                <div class="agent-name">${agentData.name}</div>
                <div class="agent-role">${agentData.role}</div>
            `;

            agentCard.addEventListener('click', function() {
                toggleAgent(agentId);
            });

            agentGrid.appendChild(agentCard);
        }

        // ‰øùÂ≠òËá™ÂÆö‰πâÂú∫ÊôØ
        function saveCustomScene() {
            const formData = {
                name: document.getElementById('sceneName').value,
                description: document.getElementById('sceneDescription').value,
                objectives: document.getElementById('learningObjectives').value,
                difficulty: document.getElementById('sceneDifficulty').value,
                recommendedAgents: Array.from(document.getElementById('recommendedAgents').selectedOptions).map(o => o.value),
                rules: document.getElementById('sceneRules').value
            };

            // ÁîüÊàêÂîØ‰∏ÄID
            const sceneId = 'custom_' + Date.now();

            // Ê∑ªÂä†Âà∞Âú∫ÊôØÂàóË°®
            scenes[sceneId] = {
                name: formData.name,
                description: formData.description,
                learning_objectives: formData.objectives,
                difficulty: formData.difficulty,
                recommended_agents: formData.recommendedAgents,
                rules: formData.rules,
                isCustom: true
            };

            // Ê∑ªÂä†Âà∞ÈÄâÊã©Âô®
            const sceneSelect = document.getElementById('sceneSelect');
            const option = document.createElement('option');
            option.value = sceneId;
            option.textContent = formData.name;
            sceneSelect.appendChild(option);

            closeModal('sceneEditorModal');
            showNotification(`Ëá™ÂÆö‰πâÂú∫ÊôØ ${formData.name} ‰øùÂ≠òÊàêÂäüÔºÅ`, 'success');

            // ÈáçÁΩÆË°®Âçï
            document.getElementById('sceneEditorForm').reset();
        }

        // Â∞èËØ¥Âàõ‰ΩúÂäüËÉΩ
        function startNovelBrainstorm() {
            document.getElementById('novelModal').style.display = 'block';
        }

        function viewNovelHistory() {
            showNotification('Â∞èËØ¥ÂéÜÂè≤ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...', 'info');
        }

        function startBrainstorm() {
            const theme = document.getElementById('novelTheme').value;
            showNotification('ÂºÄÂßãÂ§¥ËÑëÈ£éÊö¥‰ºöËÆÆ...', 'info');

            // Ê®°ÊãüÊô∫ËÉΩ‰ΩìÂèÇ‰∏éÂ§¥ËÑëÈ£éÊö¥
            setTimeout(() => {
                addNovelMessage('tanaka', `ÂÖ≥‰∫é${getThemeName(theme)}‰∏ªÈ¢òÔºåÊàëÂª∫ËÆÆÊàë‰ª¨ËÆæÂÆö‰∏Ä‰∏™ÊúâË∂£ÁöÑÂâçÊèê...`);
            }, 1000);

            setTimeout(() => {
                addNovelMessage('koumi', 'ÂìáÔºÅËøô‰∏™ÊÉ≥Ê≥ïÂæàÊ£íÔºÅÊàë‰ª¨ÂèØ‰ª•Âä†ÂÖ•‰∏Ä‰∫õÂπ¥ËΩª‰∫∫ÂñúÊ¨¢ÁöÑÂÖÉÁ¥†...');
            }, 2500);

            setTimeout(() => {
                addNovelMessage('yamada', 'ËÆ©ÊàëÊù•Ë°•ÂÖÖ‰∏Ä‰∫õÊñáÂåñËÉåÊôØÔºåËøôÊ†∑ÊïÖ‰∫ã‰ºöÊõ¥ÊúâÊ∑±Â∫¶...');
            }, 4000);
        }

        function continueWriting() {
            showNotification('Êô∫ËÉΩ‰ΩìÊ≠£Âú®Âçè‰ΩúÂàõ‰Ωú‰∏ã‰∏ÄÊÆµ...', 'info');

            setTimeout(() => {
                const novelWorkspace = document.getElementById('novelWorkspace');
                const newParagraph = document.createElement('div');
                newParagraph.style.cssText = 'background: #e6fffa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #38a169;';
                newParagraph.innerHTML = '<strong>Âçè‰ΩúÂàõ‰Ωú - Á¨¨4ÊÆµ</strong><br>"ÁæéÂí≤Â∞èÂøÉÁøºÁøºÂú∞Êé®ÂºÄÂíñÂï°Â∫óÁöÑÈó®Ôºå‰∏ÄËÇ°Ê∑°Ê∑°ÁöÑÊ®±Ëä±È¶ôÂë≥ÊâëÈù¢ËÄåÊù•„ÄÇÂ∫óÂÜÖÊòèÊöóÁöÑÁÅØÂÖâ‰∏ãÔºåÂ•πÁúãÂà∞‰∫Ü‰∏Ä‰∏™ÁÜüÊÇâÁöÑË∫´ÂΩ±..."';
                novelWorkspace.appendChild(newParagraph);
                novelWorkspace.scrollTop = novelWorkspace.scrollHeight;
            }, 2000);
        }

        function exportNovel() {
            const novelContent = document.getElementById('novelWorkspace').textContent;
            const blob = new Blob([novelContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Âçè‰ΩúÂ∞èËØ¥_' + new Date().toLocaleDateString() + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Â∞èËØ¥Â∑≤ÂØºÂá∫ÔºÅ', 'success');
        }

        function addNovelMessage(agentId, content) {
            const workspace = document.getElementById('novelWorkspace');
            const message = document.createElement('div');
            message.className = 'message';

            const agent = agents[agentId];
            message.innerHTML = `
                <div class="message-avatar" style="${getAgentAvatarStyle(agentId)}">${agent.avatar}</div>
                <div class="message-content">
                    <div class="message-meta">
                        <strong>${agent.name}</strong>
                        <span>Âàõ‰ΩúËÆ®ËÆ∫</span>
                    </div>
                    <div>${content}</div>
                </div>
            `;

            workspace.appendChild(message);
            workspace.scrollTop = workspace.scrollHeight;
        }

        function getThemeName(theme) {
            const themes = {
                urban_fantasy: 'ÈÉΩÂ∏ÇÂ•áÂπª',
                school_life: 'Ê†°Âõ≠ÁîüÊ¥ª',
                historical: 'ÂéÜÂè≤Ââß',
                sci_fi: 'ÁßëÂπªÊú™Êù•',
                romance: 'Êµ™Êº´Áà±ÊÉÖ',
                mystery: 'ÊÇ¨ÁñëÊé®ÁêÜ'
            };
            return themes[theme] || theme;
        }

        // Êõ¥Êñ∞Â≠¶‰π†ËøõÂ∫¶
        function updateLearningProgress() {
            // Ê®°ÊãüÂ≠¶‰π†ËøõÂ∫¶Êõ¥Êñ∞
            const progressTypes = ['grammar', 'vocabulary', 'culture'];
            const randomType = progressTypes[Math.floor(Math.random() * progressTypes.length)];

            switch (randomType) {
                case 'grammar':
                    learningStats.grammar = Math.min(100, learningStats.grammar + Math.floor(Math.random() * 3) + 1);
                    document.getElementById('grammarScore').textContent = learningStats.grammar + '%';
                    document.querySelector('.progress-fill').style.width = learningStats.grammar + '%';
                    break;
                case 'vocabulary':
                    learningStats.vocabulary += Math.floor(Math.random() * 5) + 1;
                    document.getElementById('vocabScore').textContent = learningStats.vocabulary + ' ËØç';
                    break;
                case 'culture':
                    learningStats.culture = Math.min(100, learningStats.culture + Math.floor(Math.random() * 2) + 1);
                    document.getElementById('cultureScore').textContent = learningStats.culture + '%';
                    break;
            }

            // Êõ¥Êñ∞‰ªäÊó•Â≠¶‰π†Êó∂Èó¥
            learningStats.todayTime += Math.floor(Math.random() * 3) + 1;
            document.getElementById('todayTime').textContent = learningStats.todayTime + ' ÂàÜÈíü';

            // Ê£ÄÊü•ÊàêÂ∞±Ëß£ÈîÅ
            checkAchievements();
        }

        // Ê£ÄÊü•ÊàêÂ∞±Ëß£ÈîÅ
        function checkAchievements() {
            const achievements = document.querySelectorAll('.achievement-item:not(.unlocked)');

            achievements.forEach(achievement => {
                const achievementText = achievement.textContent;
                let shouldUnlock = false;

                if (achievementText.includes('ÊñáÂåñ‰∏ìÂÆ∂') && learningStats.culture >= 60) {
                    shouldUnlock = true;
                } else if (achievementText.includes('JLPTÊåëÊàòËÄÖ') && learningStats.grammar >= 80) {
                    shouldUnlock = true;
                }

                if (shouldUnlock) {
                    achievement.classList.add('unlocked');
                    const achievementName = achievement.querySelector('strong').textContent;
                    showNotification(`üéâ ÊàêÂ∞±Ëß£ÈîÅÔºö${achievementName}ÔºÅ`, 'success');
                }
            });
        }

        // ÈÄöÁü•Á≥ªÁªü
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ‰øÆÊîπÔºöÂÆöÊúüÊõ¥Êñ∞Á≥ªÁªü
        function startPeriodicUpdates() {
            // ÊØè30ÁßíÊ£ÄÊü•ÂêéÁ´ØËøûÊé•Áä∂ÊÄÅ
            setInterval(async () => {
                const wasConnected = backendConnected;
                await checkBackendConnection();

                // Â¶ÇÊûúËøûÊé•Áä∂ÊÄÅÊîπÂèòÔºåÊõ¥Êñ∞UI
                if (wasConnected !== backendConnected) {
                    updateBackendStatus(backendConnected);
                }
            }, 30000);

            // ÊØè30ÁßíÊõ¥Êñ∞Êô∫ËÉΩ‰ΩìÊÉÖÁª™
            setInterval(() => {
                if (!isThinking) {
                    currentAgents.forEach(agentId => {
                        updateAgentEmotion(agentId);
                    });
                }
            }, 30000);

            // ÊØèÂàÜÈíüÊõ¥Êñ∞Â≠¶‰π†Êó∂Èó¥
            setInterval(() => {
                learningStats.todayTime += 1;
                document.getElementById('todayTime').textContent = learningStats.todayTime + ' ÂàÜÈíü';
            }, 60000);

            // ÊØè10ÂàÜÈíüÊòæÁ§∫Â≠¶‰π†ÊèêÈÜí
            setInterval(() => {
                const reminders = [
                    'ËÆ∞ÂæóÂ§ç‰π†‰ªäÂ§©Â≠¶ËøáÁöÑÂÜÖÂÆπÂì¶ÔºÅ',
                    'ËØïËØïÂíå‰∏çÂêåÁöÑÊô∫ËÉΩ‰ΩìÂØπËØùÂêßÔºÅ',
                    'Ë¶Å‰∏çË¶ÅÊåëÊàò‰∏Ä‰∏ãÊñ∞ÁöÑÂú∫ÊôØÔºü',
                    'Â≠¶‰π†ËøõÂ∫¶ÂæàÊ£íÔºåÁªßÁª≠Âä†Ê≤πÔºÅ'
                ];
                const randomReminder = reminders[Math.floor(Math.random() * reminders.length)];
                showNotification(randomReminder, 'info');
            }, 600000);
        }

        // ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter ÂèëÈÄÅÊ∂àÊÅØ
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                sendMessage();
            }

            // Esc ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            // Êï∞Â≠óÈîÆ1-6Âø´ÈÄüÂàáÊç¢Êô∫ËÉΩ‰Ωì
            if (e.key >= '1' && e.key <= '6') {
                const agentIds = ['tanaka', 'koumi', 'ai', 'yamada', 'sato', 'membot'];
                const agentId = agentIds[parseInt(e.key) - 1];
                if (agentId) {
                    toggleAgent(agentId);
                }
            }
        });

        // Á™óÂè£ÂÖ≥Èó≠Êó∂ÁöÑÊèêÈÜí
        window.addEventListener('beforeunload', function(e) {
            if (chatHistory.length > 0) {
                e.preventDefault();
                e.returnValue = 'Á°ÆÂÆöË¶ÅÁ¶ªÂºÄÂêóÔºüËÅäÂ§©ËÆ∞ÂΩïÂ∞Ü‰ºö‰∏¢Â§±„ÄÇ';
            }
        });

        // ÁßªÂä®Á´Ø‰ºòÂåñ
        if (window.innerWidth <= 768) {
            // ÁßªÂä®Á´ØÁâπÊÆäÂ§ÑÁêÜ
            document.querySelector('.main-layout').style.height = 'auto';
            document.querySelector('.chat-area').style.height = '60vh';

            // Ëß¶Êë∏‰∫ã‰ª∂‰ºòÂåñ
            document.querySelectorAll('.agent-card').forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });

                card.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
        }

        // ËØ≠Èü≥ÂäüËÉΩÂ¢ûÂº∫
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            let voiceManager = null;

            // ÈáçÂÜô startVoiceInput ÂáΩÊï∞
            const originalStartVoiceInput = window.startVoiceInput;
            window.startVoiceInput = function() {
                if (!voiceManager) {
                    try {
                        voiceManager = new VoiceInputManager();
                    } catch (error) {
                        console.error('ËØ≠Èü≥ÂäüËÉΩÂàùÂßãÂåñÂ§±Ë¥•:', error);
                        if (originalStartVoiceInput) originalStartVoiceInput();
                        return;
                    }
                }
                voiceManager.startVoiceInput();
            };
        }
    </script>
    <script src="assets/js/voice.js"></script>
    <script src="assets/js/voice-integration.js"></script>
</body>
</html>