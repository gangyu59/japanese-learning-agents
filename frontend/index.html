<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ æ—¥è¯­å­¦ä¹ Multi-Agentç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* æ–°å¢ï¼šé¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-brand h3 {
            margin: 0;
            color: #667eea;
        }

        .backend-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #fff3cd;
            color: #856404;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover {
            background: #f0f0f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px; /* æ–°å¢ï¼šä¸ºå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }

        .chat-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .agent-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .agent-card.active {
            border-color: #4299e1;
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
        }

        .agent-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .agent-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .agent-role {
            font-size: 0.8em;
            color: #718096;
        }

        .agent-emotion {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeInUp 0.5s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            color: white;
            font-weight: bold;
        }

        .message-content {
            background: white;
            padding: 15px;
            border-radius: 15px;
            max-width: 70%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8em;
            color: #718096;
        }

        .message.user .message-meta {
            color: rgba(255,255,255,0.8);
        }

        .thinking-indicator {
            display: none;
            padding: 10px 20px;
            background: #fff3cd;
            border-radius: 20px;
            margin: 10px 0;
            font-style: italic;
            color: #856404;
        }

        .thinking-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-height: 50px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            resize: none;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            border-color: #4299e1;
        }

        .send-btn, .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .voice-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .send-btn:hover, .voice-btn:hover {
            transform: scale(1.1);
        }

        .learning-stats {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            transition: width 0.3s ease;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .action-btn:hover {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .scene-selector {
            margin-bottom: 20px;
        }

        .scene-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .collaboration-panel {
            background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .collaboration-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .agent-participation {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .participant-badge {
            background: #4299e1;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
        }

        .novel-creation {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-radius: 10px;
            padding: 15px;
        }

        .novel-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .novel-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: #48bb78;
            color: white;
            cursor: pointer;
            font-size: 0.8em;
        }

        .novel-progress {
            background: white;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .personality-sliders {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
        }

        .slider-group label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .slider {
            width: 100%;
        }

        .slider-value {
            text-align: center;
            font-weight: bold;
            color: #4299e1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
        }

        .achievements {
            background: linear-gradient(135deg, #faf5ff 0%, #e9d5ff 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
        }

        .achievement-item.unlocked {
            background: rgba(72, 187, 120, 0.1);
        }

        .achievement-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 1s;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: calc(100vh - 150px);
            }

            .sidebar {
                height: auto;
                max-height: 200px;
            }

            .agent-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav-links {
                display: none;
            }
        }
    </style>
    <link href="assets/css/voice-minimal.css" rel="stylesheet">
</head>
<body>
    <!-- æ–°å¢ï¼šé¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-nav">
        <div class="nav-brand">
            <h3>ğŸŒ æ—¥è¯­å­¦ä¹ ç³»ç»Ÿ</h3>
            <span id="backendStatus" class="backend-status status-offline">ğŸŸ¡ æ£€æµ‹ä¸­...</span>
        </div>
        <div class="nav-links">
            <a href="#" onclick="navigateToPage('chat')">ğŸ’¬ å¯¹è¯</a>
            <a href="pages/agents.html">ğŸ¤– æ™ºèƒ½ä½“</a>
            <a href="pages/learning.html">ğŸ“š å­¦ä¹ </a>
            <a href="pages/novel.html">ğŸ“– å°è¯´</a>
            <a href="pages/multi_agent_collaboration.html">ğŸ¤ åä½œ</a>
            <a href="pages/progress.html">ğŸ“Š è¿›åº¦</a>
            <a href="pages/achievements.html">ğŸ† æˆå°±</a>
            <a href="pages/profile.html">ğŸ‘¤ ç”¨æˆ·</a>
            <a href="pages/settings.html">âš™ï¸ è®¾ç½®</a>
            <a href="pages/user_guide.html">ğŸ“– æŒ‡å—</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>ğŸŒ æ—¥è¯­å­¦ä¹ Multi-Agentç³»ç»Ÿ</h1>
            <p>ä¸AIæ™ºèƒ½ä½“ä¸€èµ·å­¦ä¹ æ—¥è¯­ï¼Œä½“éªŒåä½œå­¦ä¹ çš„ä¹è¶£</p>
        </div>

        <div class="main-layout">
            <!-- å·¦ä¾§è¾¹æ  - æ™ºèƒ½ä½“ç®¡ç† -->
            <div class="sidebar">
                <h3><i class="fas fa-users"></i> æ™ºèƒ½ä½“å›¢é˜Ÿ</h3>
                <div class="agent-grid">
                    <div class="agent-card active" data-agent="tanaka">
                        <div class="agent-emotion">ğŸ˜</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);">ğŸ‘¨â€ğŸ«</div>
                        <div class="agent-name">ç”°ä¸­å…ˆç”Ÿ</div>
                        <div class="agent-role">è¯­æ³•ä¸“å®¶</div>
                    </div>
                    <div class="agent-card" data-agent="koumi">
                        <div class="agent-emotion">ğŸ˜Š</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);">ğŸ‘§</div>
                        <div class="agent-name">å°ç¾</div>
                        <div class="agent-role">å¯¹è¯ä¼™ä¼´</div>
                    </div>
                    <div class="agent-card" data-agent="ai">
                        <div class="agent-emotion">ğŸ¤”</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);">ğŸ¤–</div>
                        <div class="agent-name">ã‚¢ã‚¤</div>
                        <div class="agent-role">åˆ†æå¸ˆ</div>
                    </div>
                    <div class="agent-card" data-agent="yamada">
                        <div class="agent-emotion">ğŸ˜Œ</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);">ğŸŒ</div>
                        <div class="agent-name">å±±ç”°å…ˆç”Ÿ</div>
                        <div class="agent-role">æ–‡åŒ–ä¸“å®¶</div>
                    </div>
                    <div class="agent-card" data-agent="sato">
                        <div class="agent-emotion">ğŸ˜¤</div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);">ğŸ¯</div>
                        <div class="agent-name">ä½è—¤æ•™ç»ƒ</div>
                        <div class="agent-role">è€ƒè¯•ä¸“å®¶</div>
                    </div>
                    <div class="agent-card" data-agent="membot">
                        <div class="agent-emotion">ğŸ§ </div>
                        <div class="agent-avatar" style="background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);">ğŸ¤–</div>
                        <div class="agent-name">è®°å¿†ç®¡å®¶</div>
                        <div class="agent-role">å­¦ä¹ è®°å½•</div>
                    </div>
                </div>

                <div class="scene-selector">
                    <label><strong>é€‰æ‹©å­¦ä¹ åœºæ™¯</strong></label>
                    <select id="sceneSelect">
                        <option value="grammar">è¯­æ³•å­¦ä¹ </option>
                        <option value="conversation">æ—¥å¸¸å¯¹è¯</option>
                        <option value="restaurant">é¤å…åœºæ™¯</option>
                        <option value="shopping">è´­ç‰©åœºæ™¯</option>
                        <option value="interview">é¢è¯•å‡†å¤‡</option>
                        <option value="culture">æ–‡åŒ–æ¢ç´¢</option>
                        <option value="jlpt">JLPTè€ƒè¯•</option>
                    </select>
                </div>

                <div class="quick-actions">
                    <button class="action-btn" onclick="startGrammarCheck()">
                        <i class="fas fa-spell-check"></i><br>è¯­æ³•æ£€æŸ¥
                    </button>
                    <button class="action-btn" onclick="startVocabExpansion()">
                        <i class="fas fa-book"></i><br>è¯æ±‡æ‰©å±•
                    </button>
                    <button class="action-btn" onclick="startCulturalContext()">
                        <i class="fas fa-torii-gate"></i><br>æ–‡åŒ–èƒŒæ™¯
                    </button>
                    <button class="action-btn" onclick="startJLPTPrep()">
                        <i class="fas fa-graduation-cap"></i><br>è€ƒè¯•å‡†å¤‡
                    </button>
                </div>

                <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openAgentCreator()">
                    <i class="fas fa-plus"></i> åˆ›å»ºè‡ªå®šä¹‰æ™ºèƒ½ä½“
                </button>

                <button class="btn-primary" style="width: 100%;" onclick="openSceneEditor()">
                    <i class="fas fa-edit"></i> ç¼–è¾‘å­¦ä¹ åœºæ™¯
                </button>
            </div>

            <!-- ä¸­å¤®èŠå¤©åŒºåŸŸ -->
            <div class="chat-area">
                <div class="collaboration-panel">
                    <div class="collaboration-status">
                        <strong>ğŸ“ åä½œçŠ¶æ€</strong>
                        <span id="activeAgentsCount">1 ä¸ªæ™ºèƒ½ä½“æ´»è·ƒ</span>
                    </div>
                    <div class="agent-participation" id="activeAgentsList">
                        <span class="participant-badge">ç”°ä¸­å…ˆç”Ÿ</span>
                    </div>
                </div>

                <div class="thinking-indicator" id="thinkingIndicator">
                    <i class="fas fa-brain"></i> æ™ºèƒ½ä½“æ­£åœ¨æ€è€ƒä¸­...
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);">ğŸ‘¨â€ğŸ«</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>ç”°ä¸­å…ˆç”Ÿ</strong>
                                <span>åˆšåˆš</span>
                            </div>
                            <div>ã“ã‚“ã«ã¡ã¯ï¼æ—¥æœ¬èªã®å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã¾ãšã€ã‚ãªãŸã®æ—¥æœ¬èªãƒ¬ãƒ™ãƒ«ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚åˆç´šã€ä¸­ç´šã€ä¸Šç´šã®ã©ã‚Œã§ã™ã‹ï¼Ÿ</div>
                            <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                                <strong>ä¸­æ–‡ç¿»è¯‘ï¼š</strong>ä½ å¥½ï¼è®©æˆ‘ä»¬å¼€å§‹å­¦ä¹ æ—¥è¯­å§ã€‚é¦–å…ˆï¼Œè¯·å‘Šè¯‰æˆ‘ä½ çš„æ—¥è¯­æ°´å¹³ã€‚æ˜¯åˆçº§ã€ä¸­çº§è¿˜æ˜¯é«˜çº§ï¼Ÿ
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <div class="input-group">
                        <textarea id="messageInput" class="input-field" placeholder="è¾“å…¥ä½ çš„æ—¥è¯­æˆ–ä¸­æ–‡..." rows="2"></textarea>
                        <button class="voice-btn" onclick="startVoiceInput()" title="è¯­éŸ³è¾“å…¥">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="send-btn" onclick="sendMessage()" title="å‘é€æ¶ˆæ¯">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§è¾¹æ  - å­¦ä¹ è¿›åº¦å’ŒåŠŸèƒ½ -->
            <div class="sidebar">
                <div class="learning-stats">
                    <h3><i class="fas fa-chart-line"></i> å­¦ä¹ è¿›åº¦</h3>
                    <div class="stat-item">
                        <span>è¯­æ³•æŒæ¡åº¦</span>
                        <span id="grammarScore">65%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%;"></div>
                    </div>

                    <div class="stat-item">
                        <span>è¯æ±‡é‡</span>
                        <span id="vocabScore">1,250 è¯</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 45%;"></div>
                    </div>

                    <div class="stat-item">
                        <span>æ–‡åŒ–ç†è§£</span>
                        <span id="cultureScore">40%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 40%;"></div>
                    </div>

                    <div class="stat-item">
                        <span>ä»Šæ—¥å­¦ä¹ æ—¶é—´</span>
                        <span id="todayTime">45 åˆ†é’Ÿ</span>
                    </div>
                </div>

                <div class="achievements">
                    <h3><i class="fas fa-trophy"></i> æˆå°±ç³»ç»Ÿ</h3>
                    <div class="achievement-item unlocked">
                        <div class="achievement-icon">ğŸ†</div>
                        <div>
                            <strong>åˆå­¦è€…</strong><br>
                            <small>å®Œæˆç¬¬ä¸€æ¬¡å¯¹è¯</small>
                        </div>
                    </div>
                    <div class="achievement-item unlocked">
                        <div class="achievement-icon">ğŸ“š</div>
                        <div>
                            <strong>è¯æ±‡å­¦è€…</strong><br>
                            <small>å­¦ä¼š100ä¸ªå•è¯</small>
                        </div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-icon">ğŸŒ</div>
                        <div>
                            <strong>æ–‡åŒ–ä¸“å®¶</strong><br>
                            <small>å®Œæˆ10ä¸ªæ–‡åŒ–ä¸»é¢˜</small>
                        </div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-icon">ğŸ¥‡</div>
                        <div>
                            <strong>JLPTæŒ‘æˆ˜è€…</strong><br>
                            <small>é€šè¿‡æ¨¡æ‹Ÿè€ƒè¯•</small>
                        </div>
                    </div>
                </div>

                <div class="novel-creation">
                    <h3><i class="fas fa-feather-alt"></i> åä½œå°è¯´</h3>
                    <div class="novel-controls">
                        <button class="novel-btn" onclick="startNovelBrainstorm()">å¼€å§‹åˆ›ä½œ</button>
                        <button class="novel-btn" onclick="viewNovelHistory()">æŸ¥çœ‹å†å²</button>
                    </div>
                    <div class="novel-progress" id="novelProgress">
                        <p><strong>å½“å‰ä¸»é¢˜ï¼š</strong>éƒ½å¸‚å¥‡å¹»å†’é™©</p>
                        <p><strong>å‚ä¸æ™ºèƒ½ä½“ï¼š</strong>ç”°ä¸­å…ˆç”Ÿ, å°ç¾, å±±ç”°å…ˆç”Ÿ</p>
                        <p><strong>åˆ›ä½œè¿›åº¦ï¼š</strong>ç¬¬3ç«  - ç¥ç§˜çš„å’–å•¡åº—</p>
                        <hr style="margin: 10px 0;">
                        <p style="font-style: italic;">"åœ¨æ¶©è°·çš„å°å··æ·±å¤„ï¼Œéšè—ç€ä¸€å®¶åªåœ¨é›¨å¤œæ‰ä¼šå‡ºç°çš„å’–å•¡åº—..."</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™ºèƒ½ä½“åˆ›å»ºæ¨¡æ€æ¡† -->
    <div class="modal" id="agentCreatorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> åˆ›å»ºè‡ªå®šä¹‰æ™ºèƒ½ä½“</h3>
                <button class="close-btn" onclick="closeModal('agentCreatorModal')">&times;</button>
            </div>

            <form id="agentCreatorForm">
                <div class="form-group">
                    <label>æ™ºèƒ½ä½“åç§°</label>
                    <input type="text" id="agentName" placeholder="ä¾‹å¦‚: æ¨±èŠ±è€å¸ˆ" required>
                </div>

                <div class="form-group">
                    <label>è§’è‰²è®¾å®š</label>
                    <textarea id="agentRole" placeholder="ä¾‹å¦‚: æ¸©æŸ”çš„åŠ¨æ¼«æ–‡åŒ–ä¸“å®¶ï¼Œå–œæ¬¢ç”¨åŠ¨æ¼«ä¾‹å­æ•™å­¦"></textarea>
                </div>

                <div class="form-group">
                    <label>ä¸“ä¸šé¢†åŸŸ</label>
                    <select id="agentExpertise" multiple>
                        <option value="grammar">è¯­æ³•</option>
                        <option value="vocabulary">è¯æ±‡</option>
                        <option value="culture">æ–‡åŒ–</option>
                        <option value="anime">åŠ¨æ¼«</option>
                        <option value="business">å•†åŠ¡</option>
                        <option value="literature">æ–‡å­¦</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ€§æ ¼ç‰¹å¾è°ƒèŠ‚</label>
                    <div class="personality-sliders">
                        <div class="slider-group">
                            <label>ä¸¥è°¨ç¨‹åº¦</label>
                            <input type="range" class="slider" id="strictness" min="1" max="10" value="5">
                            <div class="slider-value">5/10</div>
                        </div>
                        <div class="slider-group">
                            <label>å¹½é»˜æ„Ÿ</label>
                            <input type="range" class="slider" id="humor" min="1" max="10" value="5">
                            <div class="slider-value">5/10</div>
                        </div>
                        <div class="slider-group">
                            <label>è€å¿ƒåº¦</label>
                            <input type="range" class="slider" id="patience" min="1" max="10" value="7">
                            <div class="slider-value">7/10</div>
                        </div>
                        <div class="slider-group">
                            <label>åˆ›é€ åŠ›</label>
                            <input type="range" class="slider" id="creativity" min="1" max="10" value="6">
                            <div class="slider-value">6/10</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¯´è¯é£æ ¼</label>
                    <select id="speakingStyle">
                        <option value="formal">æ­£å¼</option>
                        <option value="casual">éšæ„</option>
                        <option value="friendly">å‹å¥½</option>
                        <option value="professional">ä¸“ä¸š</option>
                        <option value="playful">æ´»æ³¼</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å¤´åƒè¡¨æƒ…</label>
                    <select id="agentAvatar">
                        <option value="ğŸ‘©â€ğŸ«">ğŸ‘©â€ğŸ« å¥³è€å¸ˆ</option>
                        <option value="ğŸ‘¨â€ğŸ«">ğŸ‘¨â€ğŸ« ç”·è€å¸ˆ</option>
                        <option value="ğŸ‘©â€ğŸ“">ğŸ‘©â€ğŸ“ å¥³å­¦ç”Ÿ</option>
                        <option value="ğŸ‘¨â€ğŸ“">ğŸ‘¨â€ğŸ“ ç”·å­¦ç”Ÿ</option>
                        <option value="ğŸ§‘â€ğŸ’¼">ğŸ§‘â€ğŸ’¼ å•†åŠ¡äººå£«</option>
                        <option value="ğŸ‘©â€ğŸ¨">ğŸ‘©â€ğŸ¨ è‰ºæœ¯å®¶</option>
                        <option value="ğŸ§™â€â™€ï¸">ğŸ§™â€â™€ï¸ æ™ºè€…</option>
                        <option value="ğŸ¤–">ğŸ¤– AIåŠ©æ‰‹</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%;">
                    <i class="fas fa-plus"></i> åˆ›å»ºæ™ºèƒ½ä½“
                </button>
            </form>
        </div>
    </div>

    <!-- åœºæ™¯ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div class="modal" id="sceneEditorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> ç¼–è¾‘å­¦ä¹ åœºæ™¯</h3>
                <button class="close-btn" onclick="closeModal('sceneEditorModal')">&times;</button>
            </div>

            <form id="sceneEditorForm">
                <div class="form-group">
                    <label>åœºæ™¯åç§°</label>
                    <input type="text" id="sceneName" placeholder="ä¾‹å¦‚: ä¸œäº¬å’–å•¡åº—" required>
                </div>

                <div class="form-group">
                    <label>åœºæ™¯æè¿°</label>
                    <textarea id="sceneDescription" placeholder="è¯¦ç»†æè¿°è¿™ä¸ªåœºæ™¯çš„ç¯å¢ƒã€æ°›å›´å’ŒèƒŒæ™¯..."></textarea>
                </div>

                <div class="form-group">
                    <label>å­¦ä¹ ç›®æ ‡</label>
                    <textarea id="learningObjectives" placeholder="è¿™ä¸ªåœºæ™¯ä¸»è¦å¸®åŠ©å­¦ä¹ ä»€ä¹ˆå†…å®¹ï¼Ÿ"></textarea>
                </div>

                <div class="form-group">
                    <label>éš¾åº¦çº§åˆ«</label>
                    <select id="sceneDifficulty">
                        <option value="beginner">åˆçº§</option>
                        <option value="intermediate">ä¸­çº§</option>
                        <option value="advanced">é«˜çº§</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ¨èæ™ºèƒ½ä½“</label>
                    <select id="recommendedAgents" multiple>
                        <option value="tanaka">ç”°ä¸­å…ˆç”Ÿ</option>
                        <option value="koumi">å°ç¾</option>
                        <option value="ai">ã‚¢ã‚¤</option>
                        <option value="yamada">å±±ç”°å…ˆç”Ÿ</option>
                        <option value="sato">ä½è—¤æ•™ç»ƒ</option>
                        <option value="membot">è®°å¿†ç®¡å®¶</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>åœºæ™¯è§„åˆ™</label>
                    <textarea id="sceneRules" placeholder="åœ¨è¿™ä¸ªåœºæ™¯ä¸­çš„ç‰¹æ®Šè§„åˆ™æˆ–é™åˆ¶..."></textarea>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> ä¿å­˜åœºæ™¯
                </button>
            </form>
        </div>
    </div>

    <!-- å°è¯´åˆ›ä½œæ¨¡æ€æ¡† -->
    <div class="modal" id="novelModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-feather-alt"></i> åä½œå°è¯´åˆ›ä½œ</h3>
                <button class="close-btn" onclick="closeModal('novelModal')">&times;</button>
            </div>

            <div id="novelContent">
                <div class="form-group">
                    <label>é€‰æ‹©åˆ›ä½œä¸»é¢˜</label>
                    <select id="novelTheme">
                        <option value="urban_fantasy">éƒ½å¸‚å¥‡å¹»</option>
                        <option value="school_life">æ ¡å›­ç”Ÿæ´»</option>
                        <option value="historical">å†å²å‰§</option>
                        <option value="sci_fi">ç§‘å¹»æœªæ¥</option>
                        <option value="romance">æµªæ¼«çˆ±æƒ…</option>
                        <option value="mystery">æ‚¬ç–‘æ¨ç†</option>
                    </select>
                </div>

                <div class="collaboration-panel" style="margin-bottom: 20px;">
                    <div class="collaboration-status">
                        <strong>å‚ä¸æ™ºèƒ½ä½“</strong>
                        <button class="btn-primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="startBrainstorm()">
                            å¼€å§‹å¤´è„‘é£æš´
                        </button>
                    </div>
                    <div class="agent-participation">
                        <span class="participant-badge">ç”°ä¸­å…ˆç”Ÿ (æƒ…èŠ‚è®¾è®¡)</span>
                        <span class="participant-badge">å°ç¾ (å¯¹è¯æ¶¦è‰²)</span>
                        <span class="participant-badge">å±±ç”°å…ˆç”Ÿ (æ–‡åŒ–èƒŒæ™¯)</span>
                    </div>
                </div>

                <div id="novelWorkspace" style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-height: 400px; overflow-y: auto;">
                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);">ğŸ‘¨â€ğŸ«</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>ç”°ä¸­å…ˆç”Ÿ</strong>
                                <span>åˆ›æ„æ„æ€</span>
                            </div>
                            <div>æˆ‘å»ºè®®æˆ‘ä»¬åˆ›ä½œä¸€ä¸ªå…³äºæ—¶ç©ºç©¿è¶Šçš„æ•…äº‹ã€‚ä¸»è§’æ˜¯ä¸€åç°ä»£çš„æ—¥è¯­å­¦ç”Ÿï¼Œæ„å¤–ç©¿è¶Šåˆ°äº†æ±Ÿæˆ·æ—¶ä»£...</div>
                        </div>
                    </div>

                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);">ğŸ‘§</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>å°ç¾</strong>
                                <span>è§’è‰²è®¾è®¡</span>
                            </div>
                            <div>å“‡ï¼è¿™ä¸ªæƒ³æ³•å¤ªæ£’äº†ï¼ä¸»è§’å¯ä»¥æ˜¯ä¸ªçˆ±å¥½å†å²çš„å¥³å­©å­ï¼Œåå­—å«ç¾å’²ã€‚å¥¹åœ¨ç©¿è¶Šåé‡åˆ°ä¸€ä¸ªæ­¦å£«...</div>
                        </div>
                    </div>

                    <div class="message">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);">ğŸŒ</div>
                        <div class="message-content">
                            <div class="message-meta">
                                <strong>å±±ç”°å…ˆç”Ÿ</strong>
                                <span>å†å²èƒŒæ™¯</span>
                            </div>
                            <div>å¾ˆå¥½çš„è®¾å®šï¼æˆ‘ä»¬å¯ä»¥è®¾å®šåœ¨å¾·å·å¹•åºœåæœŸï¼Œé‚£æ—¶æ­£å€¼å¼€å›½å‰å¤•ï¼Œç¤¾ä¼šå˜é©å³å°†æ¥ä¸´ï¼Œè¿™æ ·èƒ½åˆ›é€ å¾ˆå¤šæˆå‰§å†²çª...</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="continueWriting()" style="flex: 1;">
                        <i class="fas fa-pen"></i> ç»§ç»­åˆ›ä½œ
                    </button>
                    <button class="btn-primary" onclick="exportNovel()" style="flex: 1;">
                        <i class="fas fa-download"></i> å¯¼å‡ºå°è¯´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ç³»ç»Ÿ -->
    <div id="notification" class="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let currentAgents = new Set(['tanaka']);
        let chatHistory = [];
        let isThinking = false;
        let currentScene = 'grammar';
        let voiceRecognition = null;
        let learningStats = {
            grammar: 65,
            vocabulary: 1250,
            culture: 40,
            todayTime: 45
        };

        // æ–°å¢ï¼šåç«¯APIé…ç½®
        const API_BASE_URL = 'http://localhost:8000';
        let backendConnected = false;

        // æ™ºèƒ½ä½“é…ç½®
        const agents = {
            tanaka: {
                name: 'ç”°ä¸­å…ˆç”Ÿ',
                role: 'è¯­æ³•ä¸“å®¶',
                avatar: 'ğŸ‘¨â€ğŸ«',
                personality: { strict: 8, patient: 6, humor: 3 },
                expertise: ['grammar', 'formal_language'],
                speaking_style: 'formal',
                emotions: ['ğŸ˜', 'ğŸ¤”', 'ğŸ˜¤', 'ğŸ˜Š', 'ğŸ‘']
            },
            koumi: {
                name: 'å°ç¾',
                role: 'å¯¹è¯ä¼™ä¼´',
                avatar: 'ğŸ‘§',
                personality: { strict: 2, patient: 9, humor: 8 },
                expertise: ['conversation', 'casual_language', 'youth_culture'],
                speaking_style: 'casual',
                emotions: ['ğŸ˜Š', 'ğŸ˜„', 'ğŸ˜', 'ğŸ¤—', 'ğŸ˜‰']
            },
            ai: {
                name: 'ã‚¢ã‚¤',
                role: 'åˆ†æå¸ˆ',
                avatar: 'ğŸ¤–',
                personality: { strict: 5, patient: 7, humor: 4 },
                expertise: ['analysis', 'personalization', 'data'],
                speaking_style: 'professional',
                emotions: ['ğŸ¤”', 'ğŸ’¡', 'ğŸ“Š', 'ğŸ”', 'âš¡']
            },
            yamada: {
                name: 'å±±ç”°å…ˆç”Ÿ',
                role: 'æ–‡åŒ–ä¸“å®¶',
                avatar: 'ğŸŒ',
                personality: { strict: 4, patient: 8, humor: 7 },
                expertise: ['culture', 'history', 'traditions'],
                speaking_style: 'storytelling',
                emotions: ['ğŸ˜Œ', 'ğŸ', 'â›©ï¸', 'ğŸƒ', 'ğŸ“¿']
            },
            sato: {
                name: 'ä½è—¤æ•™ç»ƒ',
                role: 'è€ƒè¯•ä¸“å®¶',
                avatar: 'ğŸ¯',
                personality: { strict: 9, patient: 5, humor: 2 },
                expertise: ['jlpt', 'testing', 'strategy'],
                speaking_style: 'motivational',
                emotions: ['ğŸ˜¤', 'ğŸ’ª', 'ğŸ†', 'âš¡', 'ğŸ”¥']
            },
            membot: {
                name: 'è®°å¿†ç®¡å®¶',
                role: 'å­¦ä¹ è®°å½•',
                avatar: 'ğŸ§ ',
                personality: { strict: 6, patient: 10, humor: 5 },
                expertise: ['memory', 'progress', 'scheduling'],
                speaking_style: 'systematic',
                emotions: ['ğŸ§ ', 'ğŸ“š', 'â°', 'ğŸ’¾', 'ğŸ“ˆ']
            }
        };

        // åœºæ™¯é…ç½®
        const scenes = {
            grammar: {
                name: 'è¯­æ³•å­¦ä¹ ',
                description: 'ä¸“æ³¨äºæ—¥è¯­è¯­æ³•è§„åˆ™çš„å­¦ä¹ å’Œç»ƒä¹ ',
                recommended_agents: ['tanaka', 'ai', 'membot'],
                difficulty: 'all_levels'
            },
            conversation: {
                name: 'æ—¥å¸¸å¯¹è¯',
                description: 'ç»ƒä¹ æ—¥å¸¸ç”Ÿæ´»ä¸­çš„å¯¹è¯æŠ€å·§',
                recommended_agents: ['koumi', 'yamada', 'ai'],
                difficulty: 'beginner_intermediate'
            },
            restaurant: {
                name: 'é¤å…åœºæ™¯',
                description: 'åœ¨æ—¥å¼é¤å…ç‚¹é¤å’Œç”¨é¤çš„æƒ…å¢ƒå¯¹è¯',
                recommended_agents: ['koumi', 'yamada'],
                difficulty: 'beginner'
            },
            shopping: {
                name: 'è´­ç‰©åœºæ™¯',
                description: 'åœ¨å•†åº—è´­ç‰©æ—¶çš„æ—¥è¯­è¡¨è¾¾',
                recommended_agents: ['koumi', 'ai'],
                difficulty: 'beginner'
            },
            interview: {
                name: 'é¢è¯•å‡†å¤‡',
                description: 'å•†åŠ¡æ—¥è¯­å’Œé¢è¯•æŠ€å·§è®­ç»ƒ',
                recommended_agents: ['sato', 'tanaka', 'ai'],
                difficulty: 'advanced'
            },
            culture: {
                name: 'æ–‡åŒ–æ¢ç´¢',
                description: 'æ·±å…¥äº†è§£æ—¥æœ¬æ–‡åŒ–å’Œå†å²',
                recommended_agents: ['yamada', 'koumi'],
                difficulty: 'all_levels'
            },
            jlpt: {
                name: 'JLPTè€ƒè¯•',
                description: 'é’ˆå¯¹JLPTè€ƒè¯•çš„ä¸“é—¨è®­ç»ƒ',
                recommended_agents: ['sato', 'tanaka', 'membot'],
                difficulty: 'all_levels'
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendConnection();
            initializeEventListeners();
            initializeVoiceRecognition();
            startPeriodicUpdates();
        });

        // æ–°å¢ï¼šæ£€æŸ¥åç«¯è¿æ¥
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (response.ok) {
                    backendConnected = true;
                    updateBackendStatus(true);
                    showNotification('âœ… åç«¯è¿æ¥æˆåŠŸï¼ŒçœŸå®AIå¯¹è¯å·²å¯ç”¨ï¼', 'success');
                } else {
                    throw new Error('Backend not responding');
                }
            } catch (error) {
                backendConnected = false;
                updateBackendStatus(false);
                showNotification('âš ï¸ åç«¯æœªè¿æ¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå¯¹è¯æ¨¡å¼', 'warning');
                console.error('Backend connection failed:', error);
            }
        }

        // æ–°å¢ï¼šæ›´æ–°åç«¯çŠ¶æ€æ˜¾ç¤º
        function updateBackendStatus(isOnline) {
            const statusElement = document.getElementById('backendStatus');
            if (isOnline) {
                statusElement.textContent = 'ğŸŸ¢ AIåœ¨çº¿';
                statusElement.className = 'backend-status status-online';
            } else {
                statusElement.textContent = 'ğŸŸ¡ æ¨¡æ‹Ÿæ¨¡å¼';
                statusElement.className = 'backend-status status-offline';
            }
        }

        // æ–°å¢ï¼šé¡µé¢å¯¼èˆªå‡½æ•°
        function navigateToPage(page) {
            switch(page) {
                case 'chat':
                    // å·²ç»åœ¨èŠå¤©é¡µé¢ï¼Œæ»šåŠ¨åˆ°èŠå¤©åŒºåŸŸ
                    document.querySelector('.chat-area').scrollIntoView({ behavior: 'smooth' });
                    break;
                default:
                    showNotification('é¡µé¢è·³è½¬åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
        function initializeEventListeners() {
            // æ™ºèƒ½ä½“å¡ç‰‡ç‚¹å‡»
            document.querySelectorAll('.agent-card').forEach(card => {
                card.addEventListener('click', function() {
                    const agentId = this.dataset.agent;
                    toggleAgent(agentId);
                });
            });

            // åœºæ™¯é€‰æ‹©
            document.getElementById('sceneSelect').addEventListener('change', function() {
                changeScene(this.value);
            });

            // å‘é€æ¶ˆæ¯
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // è¡¨å•æäº¤
            document.getElementById('agentCreatorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createCustomAgent();
            });

            document.getElementById('sceneEditorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCustomScene();
            });

            // æ»‘å—æ›´æ–°
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const valueDisplay = this.parentNode.querySelector('.slider-value');
                    valueDisplay.textContent = this.value + '/10';
                });
            });
        }

        // åˆ‡æ¢æ™ºèƒ½ä½“æ¿€æ´»çŠ¶æ€
        function toggleAgent(agentId) {
            const card = document.querySelector(`.agent-card[data-agent="${agentId}"]`);

            if (currentAgents.has(agentId)) {
                if (currentAgents.size > 1) {
                    currentAgents.delete(agentId);
                    card.classList.remove('active');
                    showNotification(`${agents[agentId].name} å·²ç¦»å¼€å¯¹è¯`, 'info');
                } else {
                    showNotification('è‡³å°‘éœ€è¦ä¿æŒä¸€ä¸ªæ™ºèƒ½ä½“åœ¨çº¿ï¼', 'warning');
                    return;
                }
            } else {
                currentAgents.add(agentId);
                card.classList.add('active');
                showNotification(`${agents[agentId].name} åŠ å…¥äº†å¯¹è¯`, 'success');

                // æ™ºèƒ½ä½“åŠ å…¥æ—¶çš„æ¬¢è¿æ¶ˆæ¯
                setTimeout(() => {
                    const joinMessage = getAgentJoinMessage(agentId);
                    addMessage(agentId, joinMessage);
                }, 500);
            }

            updateActiveAgentsDisplay();
        }

        // è·å–æ™ºèƒ½ä½“åŠ å…¥æ¶ˆæ¯
        function getAgentJoinMessage(agentId) {
            const joinMessages = {
                tanaka: "å¤±ç¤¼ã—ã¾ã™ã€‚ç”°ä¸­ã§ã™ã€‚çš†ã•ã‚“ã®æ—¥æœ¬èªå­¦ç¿’ã‚’ãŠæ‰‹ä¼ã„ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚",
                koumi: "ã‚„ã£ã»ãƒ¼ï¼å°ç¾ã ã‚ˆï½ï¼ä¸€ç·’ã«æ¥½ã—ãæ—¥æœ¬èªã‚’ç·´ç¿’ã—ã‚ˆã†ï¼",
                ai: "ã“ã‚“ã«ã¡ã¯ã€ã‚¢ã‚¤ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’é€šã˜ã¦ã€ã‚ãªãŸã®å­¦ç¿’ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚",
                yamada: "ã“ã‚“ã«ã¡ã¯ã€‚å±±ç”°ã¨ç”³ã—ã¾ã™ã€‚æ—¥æœ¬ã®æ–‡åŒ–ã«ã¤ã„ã¦ã€è‰²ã€…ã¨ãŠè©±ã—ã—ã¾ã—ã‚‡ã†ã€‚",
                sato: "ä½è—¤ã ï¼è©¦é¨“åˆæ ¼ã‚’ç›®æŒ‡ã—ã¦ã€ã—ã£ã‹ã‚Šã¨ç·´ç¿’ã™ã‚‹ãï¼",
                membot: "å­¦ç¿’è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ã€‚ã‚ãªãŸã®é€²æ­©ã‚’è¨˜éŒ²ãƒ»åˆ†æã„ãŸã—ã¾ã™ã€‚"
            };
            return joinMessages[agentId] || `${agents[agentId].name}ãŒå‚åŠ ã—ã¾ã—ãŸã€‚`;
        }

        // æ›´æ–°æ´»è·ƒæ™ºèƒ½ä½“æ˜¾ç¤º
        function updateActiveAgentsDisplay() {
            const countElement = document.getElementById('activeAgentsCount');
            const listElement = document.getElementById('activeAgentsList');

            countElement.textContent = `${currentAgents.size} ä¸ªæ™ºèƒ½ä½“æ´»è·ƒ`;

            listElement.innerHTML = '';
            currentAgents.forEach(agentId => {
                const badge = document.createElement('span');
                badge.className = 'participant-badge';
                badge.textContent = agents[agentId].name;
                listElement.appendChild(badge);
            });
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.value = '';

            // æ˜¾ç¤ºæ€è€ƒæŒ‡ç¤ºå™¨
            showThinkingIndicator();

            // å¤„ç†æ¶ˆæ¯
            setTimeout(() => {
                processMessage(message);
            }, 1000);
        }

        // ä¿®æ”¹ï¼šå¤„ç†æ¶ˆæ¯å¹¶ç”Ÿæˆæ™ºèƒ½ä½“å›åº”
        async function processMessage(userMessage) {
            if (backendConnected) {
                // çœŸå®APIè°ƒç”¨
                await processMessageWithAPI(userMessage);
            } else {
                // æ¨¡æ‹Ÿå“åº”
                await processMessageMock(userMessage);
            }
        }


        // âœ… æŒ‰æ–¹æ¡ˆAï¼šå‰ç«¯æ”¹ç”¨ message å­—æ®µï¼›scene_context ä¿è¯æ˜¯å­—ç¬¦ä¸²
        async function processMessageWithAPI(userMessage) {
            try {
                const activeAgentsList = Array.from(currentAgents);

                // é€ä¸ªæ™ºèƒ½ä½“å¹¶è¡Œè¯·æ±‚ + é€ä¸ªå»¶è¿Ÿå±•ç¤º
                for (const [idx, agentId] of activeAgentsList.entries()) {
                    // æ„é€ æ­£ç¡®çš„è¯·æ±‚ä½“ï¼ˆåç«¯è¦æ±‚ message + scene_context ä¸ºå­—ç¬¦ä¸²ï¼‰
                    const requestBody = {
                        message: String(userMessage), // âš ï¸ å¿…é¡»å« message
                        user_id: "demo_user",
                        session_id: "session_" + Date.now(),
                        agent_name: agents[agentId].name,
                        scene_context:
                            (typeof currentScene === "string" && currentScene.trim() !== "")
                                ? currentScene
                                : "general" // ç»™ä¸ªå…œåº•ï¼Œé¿å…éå­—ç¬¦ä¸²å¯¼è‡´ 422
                    };

                    // å‘é€è¯·æ±‚
                    const response = await fetch(`${API_BASE_URL}/api/v1/chat/send`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json; charset=utf-8",
                            "Accept": "application/json"
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        // æˆåŠŸï¼šè§£æ JSON
                        const data = await response.json();

                        // å»¶è¿Ÿæ˜¾ç¤ºå›åº”ä»¥æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´ï¼ˆæŒ‰åºæ’é˜Ÿï¼‰
                        setTimeout(() => {
                            // 1) æ™ºèƒ½ä½“å›å¤
                            addMessage(agentId, data.response || "æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”ã€‚");

                            // 2) æ›´æ–°æƒ…ç»ª
                            updateAgentEmotion(agentId);

                            // 3) å­¦ä¹ ç‚¹
                            if (Array.isArray(data.learning_points) && data.learning_points.length > 0) {
                                showNotification(`ğŸ“š å­¦ä¹ ç‚¹: ${data.learning_points.join(", ")}`, "info");
                            }

                            // 4) å»ºè®®
                            if (Array.isArray(data.suggestions) && data.suggestions.length > 0) {
                                showNotification(`ğŸ’¡ å»ºè®®: ${data.suggestions.join(", ")}`, "success");
                            }
                        }, idx * 1000 + 500);

                    } else {
                        // å¤±è´¥ï¼šå°½é‡è§£æåç«¯é”™è¯¯ï¼ˆJSON ä¼˜å…ˆï¼Œé€€å›æ–‡æœ¬ï¼‰
                        let errorPayload;
                        try {
                            errorPayload = await response.clone().json();
                        } catch {
                            errorPayload = await response.text();
                        }
                        console.error("APIè°ƒç”¨å¤±è´¥:", response.status, errorPayload);

                        // å›é€€åˆ°æ¨¡æ‹Ÿå“åº”
                        setTimeout(() => {
                            const mockResponse = generateAgentResponse(agentId, userMessage);
                            addMessage(agentId, mockResponse + "\n\n*[APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå“åº”]*");
                            updateAgentEmotion(agentId);
                        }, idx * 1000 + 500);
                    }
                }

                // æ‰€æœ‰ä»£ç†æ˜¾ç¤ºå®Œåï¼Œæ”¶å°¾
                setTimeout(() => {
                    hideThinkingIndicator?.();
                    updateLearningProgress?.();
                }, activeAgentsList.length * 1000 + 1000);

            } catch (error) {
                console.error("APIè¯·æ±‚é”™è¯¯:", error);
                showNotification("ç½‘ç»œé”™è¯¯ï¼Œåˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼", "warning");
                await processMessageMock(userMessage);
            }
        }

        // æ–°å¢ï¼šæ¨¡æ‹Ÿå“åº”å¤„ç†
        async function processMessageMock(userMessage) {
            const responses = [];

            // æ ¹æ®å½“å‰åœºæ™¯å’Œæ´»è·ƒæ™ºèƒ½ä½“ç”Ÿæˆå›åº”
            currentAgents.forEach(agentId => {
                const response = generateAgentResponse(agentId, userMessage);
                responses.push({ agentId, response: response + "\n\n*[æ¨¡æ‹Ÿå“åº”]*" });
            });

            // éšæœºå»¶è¿Ÿæ˜¾ç¤ºå„æ™ºèƒ½ä½“å›åº”
            responses.forEach((item, index) => {
                setTimeout(() => {
                    addMessage(item.agentId, item.response);
                    updateAgentEmotion(item.agentId);

                    if (index === responses.length - 1) {
                        hideThinkingIndicator();
                        updateLearningProgress();
                    }
                }, index * (500 + Math.random() * 1000));
            });
        }

        // ç”Ÿæˆæ™ºèƒ½ä½“å›åº”
        function generateAgentResponse(agentId, userMessage) {
            const agent = agents[agentId];
            const scene = scenes[currentScene];

            // åŸºäºæ™ºèƒ½ä½“ç±»å‹å’Œåœºæ™¯ç”Ÿæˆä¸åŒå›åº”
            const responses = {
                tanaka: {
                    grammar: [
                        "æ–‡æ³•ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚ã€Œ" + userMessage + "ã€ã®æ–‡æ³•æ§‹é€ ã‚’åˆ†æã™ã‚‹ã¨...",
                        "ãã®è¡¨ç¾ã¯æ­£ã—ã„ã§ã™ãŒã€ã‚ˆã‚Šè‡ªç„¶ãªè¨€ã„æ–¹ã‚‚ã‚ã‚Šã¾ã™ã€‚",
                        "åŠ©è©ã®ä½¿ã„æ–¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°..."
                    ],
                    conversation: [
                        "ä¸å¯§èªã‚’ä½¿ã†å ´é¢ã§ã¯ã€ã“ã®ã‚ˆã†ã«è¡¨ç¾ã—ã¾ã—ã‚‡ã†ã€‚",
                        "æ—¥å¸¸ä¼šè©±ã§ã¯ã€ã‚‚ã†å°‘ã—ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªè¡¨ç¾ã‚‚ä½¿ãˆã¾ã™ã€‚"
                    ]
                },
                koumi: {
                    conversation: [
                        "ã‚ã€ãã‚Œåˆ†ã‹ã‚‹ï¼ç§ãŸã¡ã‚‚ã‚ˆãä½¿ã†ã‚ˆï½",
                        "ä»Šåº¦ã¯ç§ãŒç­”ãˆã‚‹ç•ªã ã­ï¼ãˆãƒ¼ã£ã¨...",
                        "ãã†ã„ã†æ™‚ã¯ã€ã“ã‚“ãªæ„Ÿã˜ã§è¨€ã†ã¨è‡ªç„¶ã ã‚ˆï¼"
                    ],
                    restaurant: [
                        "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§ã¯ã€Œã™ã¿ã¾ã›ã‚“ã€ã£ã¦å‘¼ã¶ã®ãŒæ™®é€šã ã‚ˆï¼",
                        "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¦‹ãªãŒã‚‰ã€Œã“ã‚Œã€ãŠã„ã—ãã†ï¼ã€ã£ã¦è¨€ãˆã‚‹ã­ã€‚"
                    ]
                },
                ai: [
                    "ãƒ‡ãƒ¼ã‚¿åˆ†æã«ã‚ˆã‚‹ã¨ã€ã‚ãªãŸã®å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯...",
                    "ã“ã®è¡¨ç¾ã®ç¿’å¾—åº¦ã¯78%ã§ã™ã€‚å¾©ç¿’ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",
                    "é¡ä¼¼è¡¨ç¾ã¨ã®æ¯”è¼ƒçµæœã‚’ãŠç¤ºã—ã—ã¾ã™ã€‚"
                ],
                yamada: {
                    culture: [
                        "ã“ã®è¡¨ç¾ã«ã¯èˆˆå‘³æ·±ã„æ–‡åŒ–çš„èƒŒæ™¯ãŒã‚ã‚Šã¾ã™ã€‚",
                        "æ—¥æœ¬ã§ã¯æ˜”ã‹ã‚‰ã€ã“ã®ã‚ˆã†ãªå ´é¢ã§...",
                        "å­£ç¯€ã®æŒ¨æ‹¶ã¯æ—¥æœ¬æ–‡åŒ–ã®é‡è¦ãªè¦ç´ ã§ã™ã­ã€‚"
                    ]
                },
                sato: {
                    jlpt: [
                        "JLPT N3ãƒ¬ãƒ™ãƒ«ã®é‡è¦è¡¨ç¾ã§ã™ï¼å¿…ãšè¦šãˆã¦ãã ã•ã„ã€‚",
                        "è©¦é¨“ã§ã‚ˆãå‡ºã‚‹æ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã­ã€‚",
                        "ã“ã®å•é¡Œå½¢å¼ã§ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚"
                    ]
                },
                membot: [
                    "å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ä»Šæ—¥ã®é€²æ­©ç‡: +5%",
                    "ã“ã®å˜èªã¯3å›ç›®ã®å‡ºç¾ã§ã™ã€‚å®šç€åº¦ãŒå‘ä¸Šã—ã¦ã„ã¾ã™ã€‚",
                    "å¾©ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª¿æ•´ã—ã¾ã—ãŸã€‚"
                ]
            };

            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ã®å›ç­”ãŒã‚ã‚‹å ´åˆã¯ä½¿ç”¨
            let agentResponses = responses[agentId];
            if (typeof agentResponses === 'object' && agentResponses[currentScene]) {
                agentResponses = agentResponses[currentScene];
            } else if (typeof agentResponses === 'object') {
                agentResponses = agentResponses.conversation || Object.values(agentResponses)[0];
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ã«å›ç­”ã‚’é¸æŠ
            const randomResponse = agentResponses[Math.floor(Math.random() * agentResponses.length)];

            // ä¸­æ–‡ç¿»è¯‘
            const translations = {
                "æ–‡æ³•ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†": "è®©æˆ‘ä»¬ç¡®è®¤ä¸€ä¸‹è¯­æ³•",
                "ãã®è¡¨ç¾ã¯æ­£ã—ã„ã§ã™": "è¿™ä¸ªè¡¨è¾¾æ˜¯æ­£ç¡®çš„",
                "åŠ©è©ã®ä½¿ã„æ–¹ã«æ³¨æ„": "è¯·æ³¨æ„åŠ©è¯çš„ç”¨æ³•",
                "ãƒ‡ãƒ¼ã‚¿åˆ†æã«ã‚ˆã‚‹ã¨": "æ ¹æ®æ•°æ®åˆ†æ",
                "å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸ": "å·²æ›´æ–°å­¦ä¹ è®°å½•"
            };

            let translation = "";
            for (const [japanese, chinese] of Object.entries(translations)) {
                if (randomResponse.includes(japanese)) {
                    translation = `\n\n**ä¸­æ–‡æç¤ºï¼š** ${chinese}ç›¸å…³å†…å®¹...`;
                    break;
                }
            }

            return randomResponse + translation;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(senderId, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message' + (senderId === 'user' ? ' user' : '');

            let avatarContent, senderName, avatarStyle;

            if (senderId === 'user') {
                avatarContent = 'ğŸ‘¤';
                senderName = 'ä½ ';
                avatarStyle = 'background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);';
            } else {
                const agent = agents[senderId];
                avatarContent = agent.avatar;
                senderName = agent.name;
                avatarStyle = getAgentAvatarStyle(senderId);
            }

            messageDiv.innerHTML = `
                <div class="message-avatar" style="${avatarStyle}">${avatarContent}</div>
                <div class="message-content">
                    <div class="message-meta">
                        <strong>${senderName}</strong>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div>${content}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            messageDiv.classList.add('bounce');
        }

        // è·å–æ™ºèƒ½ä½“å¤´åƒæ ·å¼
        function getAgentAvatarStyle(agentId) {
            const styles = {
                tanaka: 'background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);',
                koumi: 'background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);',
                ai: 'background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);',
                yamada: 'background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);',
                sato: 'background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);',
                membot: 'background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);'
            };
            return styles[agentId] || styles.ai;
        }

        // æ›´æ–°æ™ºèƒ½ä½“æƒ…ç»ª
        function updateAgentEmotion(agentId) {
            const card = document.querySelector(`.agent-card[data-agent="${agentId}"]`);
            const emotionElement = card.querySelector('.agent-emotion');
            const emotions = agents[agentId].emotions;
            const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
            emotionElement.textContent = randomEmotion;
        }

        // æ˜¾ç¤º/éšè—æ€è€ƒæŒ‡ç¤ºå™¨
        function showThinkingIndicator() {
            document.getElementById('thinkingIndicator').classList.add('active');
            isThinking = true;
        }

        function hideThinkingIndicator() {
            document.getElementById('thinkingIndicator').classList.remove('active');
            isThinking = false;
        }

        // åœºæ™¯åˆ‡æ¢
        function changeScene(sceneId) {
            currentScene = sceneId;
            const scene = scenes[sceneId];

            showNotification(`åœºæ™¯åˆ‡æ¢åˆ°: ${scene.name}`, 'info');

            // æ¨èæ™ºèƒ½ä½“
            if (scene.recommended_agents) {
                highlightRecommendedAgents(scene.recommended_agents);
            }

            // æ·»åŠ åœºæ™¯è½¬æ¢æ¶ˆæ¯
            setTimeout(() => {
                addMessage('system', `åœºæ™¯å·²åˆ‡æ¢åˆ°ï¼š${scene.name}ã€‚${scene.description}`);
            }, 500);
        }

        // é«˜äº®æ¨èæ™ºèƒ½ä½“
        function highlightRecommendedAgents(recommendedAgents) {
            document.querySelectorAll('.agent-card').forEach(card => {
                const agentId = card.dataset.agent;
                if (recommendedAgents.includes(agentId)) {
                    card.style.border = '2px solid #48bb78';
                    card.style.boxShadow = '0 0 15px rgba(72, 187, 120, 0.3)';
                    setTimeout(() => {
                        card.style.border = '';
                        card.style.boxShadow = '';
                    }, 3000);
                }
            });
        }

        // å¿«é€Ÿæ“ä½œåŠŸèƒ½
        function startGrammarCheck() {
            changeScene('grammar');
            if (!currentAgents.has('tanaka')) {
                toggleAgent('tanaka');
            }
            addMessage('tanaka', 'èªæ³•ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ã€‚æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\n**ä¸­æ–‡æç¤ºï¼š** è¯·è¾“å…¥éœ€è¦æ£€æŸ¥è¯­æ³•çš„æ—¥è¯­å¥å­ã€‚');
        }

        function startVocabExpansion() {
            if (!currentAgents.has('koumi')) {
                toggleAgent('koumi');
            }
            if (!currentAgents.has('ai')) {
                toggleAgent('ai');
            }
            addMessage('koumi', 'èªå½™ã‚’å¢—ã‚„ãã†ï¼ä½•ã‹å˜èªã‚’æ•™ãˆã¦ï½\n\n**ä¸­æ–‡æç¤ºï¼š** è¯´å‡ºä¸€ä¸ªæ—¥è¯­å•è¯ï¼Œæˆ‘ä»¬æ¥æ‰©å±•ç›¸å…³è¯æ±‡ï¼');
        }

        function startCulturalContext() {
            changeScene('culture');
            if (!currentAgents.has('yamada')) {
                toggleAgent('yamada');
            }
            addMessage('yamada', 'æ—¥æœ¬ã®æ–‡åŒ–ã«ã¤ã„ã¦ä½•ã‹èããŸã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\n\n**ä¸­æ–‡æç¤ºï¼š** æœ‰ä»€ä¹ˆæƒ³äº†è§£çš„æ—¥æœ¬æ–‡åŒ–å—ï¼Ÿ');
        }

        function startJLPTPrep() {
            changeScene('jlpt');
            if (!currentAgents.has('sato')) {
                toggleAgent('sato');
            }
            if (!currentAgents.has('membot')) {
                toggleAgent('membot');
            }
            addMessage('sato', 'JLPTå¯¾ç­–ã‚’å§‹ã‚ã‚ˆã†ï¼ç›®æ¨™ãƒ¬ãƒ™ãƒ«ã¯ä½•ç´šã§ã™ã‹ï¼Ÿ\n\n**ä¸­æ–‡æç¤ºï¼š** å¼€å§‹JLPTå¤‡è€ƒï¼ç›®æ ‡æ˜¯å‡ çº§ï¼Ÿ');
        }

        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();
                voiceRecognition.lang = 'ja-JP';
                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = false;

                voiceRecognition.onresult = function(event) {
                    const result = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = result;
                    showNotification('è¯­éŸ³è¯†åˆ«å®Œæˆï¼', 'success');
                };

                voiceRecognition.onerror = function(event) {
                    showNotification('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
                };
            }
        }

        function startVoiceInput() {
            if (typeof VoiceInputManager !== 'undefined') {
                if (!window.voiceManagerInstance) {
                    window.voiceManagerInstance = new VoiceInputManager();
                }
                window.voiceManagerInstance.startVoiceInput();
            } else {
                // åŸæ¥çš„ç®€å•å®ç°ä½œä¸ºåå¤‡
                if (voiceRecognition) {
                    voiceRecognition.start();
                    showNotification('æ­£åœ¨ç›‘å¬è¯­éŸ³è¾“å…¥...', 'info');
                    // ... ä½ çš„åŸå§‹ä»£ç 
                } else {
                    showNotification('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'warning');
                }
            }
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openAgentCreator() {
            document.getElementById('agentCreatorModal').style.display = 'block';
        }

        function openSceneEditor() {
            document.getElementById('sceneEditorModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // åˆ›å»ºè‡ªå®šä¹‰æ™ºèƒ½ä½“
        function createCustomAgent() {
            const formData = {
                name: document.getElementById('agentName').value,
                role: document.getElementById('agentRole').value,
                expertise: Array.from(document.getElementById('agentExpertise').selectedOptions).map(o => o.value),
                personality: {
                    strictness: document.getElementById('strictness').value,
                    humor: document.getElementById('humor').value,
                    patience: document.getElementById('patience').value,
                    creativity: document.getElementById('creativity').value
                },
                speakingStyle: document.getElementById('speakingStyle').value,
                avatar: document.getElementById('agentAvatar').value
            };

            // ç”Ÿæˆå”¯ä¸€ID
            const customId = 'custom_' + Date.now();

            // æ·»åŠ åˆ°æ™ºèƒ½ä½“åˆ—è¡¨
            agents[customId] = {
                name: formData.name,
                role: formData.role,
                avatar: formData.avatar,
                personality: formData.personality,
                expertise: formData.expertise,
                speaking_style: formData.speakingStyle,
                emotions: ['ğŸ˜Š', 'ğŸ¤”', 'ğŸ’¡', 'ğŸ‘', 'ğŸ‰'],
                isCustom: true
            };

            // åˆ›å»ºæ™ºèƒ½ä½“å¡ç‰‡
            createAgentCard(customId, agents[customId]);

            closeModal('agentCreatorModal');
            showNotification(`è‡ªå®šä¹‰æ™ºèƒ½ä½“ ${formData.name} åˆ›å»ºæˆåŠŸï¼`, 'success');

            // é‡ç½®è¡¨å•
            document.getElementById('agentCreatorForm').reset();
            document.querySelectorAll('.slider-value').forEach(el => el.textContent = '5/10');
        }

        // åˆ›å»ºæ™ºèƒ½ä½“å¡ç‰‡
        function createAgentCard(agentId, agentData) {
            const agentGrid = document.querySelector('.agent-grid');
            const agentCard = document.createElement('div');
            agentCard.className = 'agent-card';
            agentCard.dataset.agent = agentId;

            agentCard.innerHTML = `
                <div class="agent-emotion">ğŸ˜Š</div>
                <div class="agent-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">${agentData.avatar}</div>
                <div class="agent-name">${agentData.name}</div>
                <div class="agent-role">${agentData.role}</div>
            `;

            agentCard.addEventListener('click', function() {
                toggleAgent(agentId);
            });

            agentGrid.appendChild(agentCard);
        }

        // ä¿å­˜è‡ªå®šä¹‰åœºæ™¯
        function saveCustomScene() {
            const formData = {
                name: document.getElementById('sceneName').value,
                description: document.getElementById('sceneDescription').value,
                objectives: document.getElementById('learningObjectives').value,
                difficulty: document.getElementById('sceneDifficulty').value,
                recommendedAgents: Array.from(document.getElementById('recommendedAgents').selectedOptions).map(o => o.value),
                rules: document.getElementById('sceneRules').value
            };

            // ç”Ÿæˆå”¯ä¸€ID
            const sceneId = 'custom_' + Date.now();

            // æ·»åŠ åˆ°åœºæ™¯åˆ—è¡¨
            scenes[sceneId] = {
                name: formData.name,
                description: formData.description,
                learning_objectives: formData.objectives,
                difficulty: formData.difficulty,
                recommended_agents: formData.recommendedAgents,
                rules: formData.rules,
                isCustom: true
            };

            // æ·»åŠ åˆ°é€‰æ‹©å™¨
            const sceneSelect = document.getElementById('sceneSelect');
            const option = document.createElement('option');
            option.value = sceneId;
            option.textContent = formData.name;
            sceneSelect.appendChild(option);

            closeModal('sceneEditorModal');
            showNotification(`è‡ªå®šä¹‰åœºæ™¯ ${formData.name} ä¿å­˜æˆåŠŸï¼`, 'success');

            // é‡ç½®è¡¨å•
            document.getElementById('sceneEditorForm').reset();
        }

        // å°è¯´åˆ›ä½œåŠŸèƒ½
        function startNovelBrainstorm() {
            document.getElementById('novelModal').style.display = 'block';
        }

        function viewNovelHistory() {
            showNotification('å°è¯´å†å²åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'info');
        }

        function startBrainstorm() {
            const theme = document.getElementById('novelTheme').value;
            showNotification('å¼€å§‹å¤´è„‘é£æš´ä¼šè®®...', 'info');

            // æ¨¡æ‹Ÿæ™ºèƒ½ä½“å‚ä¸å¤´è„‘é£æš´
            setTimeout(() => {
                addNovelMessage('tanaka', `å…³äº${getThemeName(theme)}ä¸»é¢˜ï¼Œæˆ‘å»ºè®®æˆ‘ä»¬è®¾å®šä¸€ä¸ªæœ‰è¶£çš„å‰æ...`);
            }, 1000);

            setTimeout(() => {
                addNovelMessage('koumi', 'å“‡ï¼è¿™ä¸ªæƒ³æ³•å¾ˆæ£’ï¼æˆ‘ä»¬å¯ä»¥åŠ å…¥ä¸€äº›å¹´è½»äººå–œæ¬¢çš„å…ƒç´ ...');
            }, 2500);

            setTimeout(() => {
                addNovelMessage('yamada', 'è®©æˆ‘æ¥è¡¥å……ä¸€äº›æ–‡åŒ–èƒŒæ™¯ï¼Œè¿™æ ·æ•…äº‹ä¼šæ›´æœ‰æ·±åº¦...');
            }, 4000);
        }

        function continueWriting() {
            showNotification('æ™ºèƒ½ä½“æ­£åœ¨åä½œåˆ›ä½œä¸‹ä¸€æ®µ...', 'info');

            setTimeout(() => {
                const novelWorkspace = document.getElementById('novelWorkspace');
                const newParagraph = document.createElement('div');
                newParagraph.style.cssText = 'background: #e6fffa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #38a169;';
                newParagraph.innerHTML = '<strong>åä½œåˆ›ä½œ - ç¬¬4æ®µ</strong><br>"ç¾å’²å°å¿ƒç¿¼ç¿¼åœ°æ¨å¼€å’–å•¡åº—çš„é—¨ï¼Œä¸€è‚¡æ·¡æ·¡çš„æ¨±èŠ±é¦™å‘³æ‰‘é¢è€Œæ¥ã€‚åº—å†…æ˜æš—çš„ç¯å…‰ä¸‹ï¼Œå¥¹çœ‹åˆ°äº†ä¸€ä¸ªç†Ÿæ‚‰çš„èº«å½±..."';
                novelWorkspace.appendChild(newParagraph);
                novelWorkspace.scrollTop = novelWorkspace.scrollHeight;
            }, 2000);
        }

        function exportNovel() {
            const novelContent = document.getElementById('novelWorkspace').textContent;
            const blob = new Blob([novelContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'åä½œå°è¯´_' + new Date().toLocaleDateString() + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('å°è¯´å·²å¯¼å‡ºï¼', 'success');
        }

        function addNovelMessage(agentId, content) {
            const workspace = document.getElementById('novelWorkspace');
            const message = document.createElement('div');
            message.className = 'message';

            const agent = agents[agentId];
            message.innerHTML = `
                <div class="message-avatar" style="${getAgentAvatarStyle(agentId)}">${agent.avatar}</div>
                <div class="message-content">
                    <div class="message-meta">
                        <strong>${agent.name}</strong>
                        <span>åˆ›ä½œè®¨è®º</span>
                    </div>
                    <div>${content}</div>
                </div>
            `;

            workspace.appendChild(message);
            workspace.scrollTop = workspace.scrollHeight;
        }

        function getThemeName(theme) {
            const themes = {
                urban_fantasy: 'éƒ½å¸‚å¥‡å¹»',
                school_life: 'æ ¡å›­ç”Ÿæ´»',
                historical: 'å†å²å‰§',
                sci_fi: 'ç§‘å¹»æœªæ¥',
                romance: 'æµªæ¼«çˆ±æƒ…',
                mystery: 'æ‚¬ç–‘æ¨ç†'
            };
            return themes[theme] || theme;
        }

        // æ›´æ–°å­¦ä¹ è¿›åº¦
        function updateLearningProgress() {
            // æ¨¡æ‹Ÿå­¦ä¹ è¿›åº¦æ›´æ–°
            const progressTypes = ['grammar', 'vocabulary', 'culture'];
            const randomType = progressTypes[Math.floor(Math.random() * progressTypes.length)];

            switch (randomType) {
                case 'grammar':
                    learningStats.grammar = Math.min(100, learningStats.grammar + Math.floor(Math.random() * 3) + 1);
                    document.getElementById('grammarScore').textContent = learningStats.grammar + '%';
                    document.querySelector('.progress-fill').style.width = learningStats.grammar + '%';
                    break;
                case 'vocabulary':
                    learningStats.vocabulary += Math.floor(Math.random() * 5) + 1;
                    document.getElementById('vocabScore').textContent = learningStats.vocabulary + ' è¯';
                    break;
                case 'culture':
                    learningStats.culture = Math.min(100, learningStats.culture + Math.floor(Math.random() * 2) + 1);
                    document.getElementById('cultureScore').textContent = learningStats.culture + '%';
                    break;
            }

            // æ›´æ–°ä»Šæ—¥å­¦ä¹ æ—¶é—´
            learningStats.todayTime += Math.floor(Math.random() * 3) + 1;
            document.getElementById('todayTime').textContent = learningStats.todayTime + ' åˆ†é’Ÿ';

            // æ£€æŸ¥æˆå°±è§£é”
            checkAchievements();
        }

        // æ£€æŸ¥æˆå°±è§£é”
        function checkAchievements() {
            const achievements = document.querySelectorAll('.achievement-item:not(.unlocked)');

            achievements.forEach(achievement => {
                const achievementText = achievement.textContent;
                let shouldUnlock = false;

                if (achievementText.includes('æ–‡åŒ–ä¸“å®¶') && learningStats.culture >= 60) {
                    shouldUnlock = true;
                } else if (achievementText.includes('JLPTæŒ‘æˆ˜è€…') && learningStats.grammar >= 80) {
                    shouldUnlock = true;
                }

                if (shouldUnlock) {
                    achievement.classList.add('unlocked');
                    const achievementName = achievement.querySelector('strong').textContent;
                    showNotification(`ğŸ‰ æˆå°±è§£é”ï¼š${achievementName}ï¼`, 'success');
                }
            });
        }

        // é€šçŸ¥ç³»ç»Ÿ
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ä¿®æ”¹ï¼šå®šæœŸæ›´æ–°ç³»ç»Ÿ
        function startPeriodicUpdates() {
            // æ¯30ç§’æ£€æŸ¥åç«¯è¿æ¥çŠ¶æ€
            setInterval(async () => {
                const wasConnected = backendConnected;
                await checkBackendConnection();

                // å¦‚æœè¿æ¥çŠ¶æ€æ”¹å˜ï¼Œæ›´æ–°UI
                if (wasConnected !== backendConnected) {
                    updateBackendStatus(backendConnected);
                }
            }, 30000);

            // æ¯30ç§’æ›´æ–°æ™ºèƒ½ä½“æƒ…ç»ª
            setInterval(() => {
                if (!isThinking) {
                    currentAgents.forEach(agentId => {
                        updateAgentEmotion(agentId);
                    });
                }
            }, 30000);

            // æ¯åˆ†é’Ÿæ›´æ–°å­¦ä¹ æ—¶é—´
            setInterval(() => {
                learningStats.todayTime += 1;
                document.getElementById('todayTime').textContent = learningStats.todayTime + ' åˆ†é’Ÿ';
            }, 60000);

            // æ¯10åˆ†é’Ÿæ˜¾ç¤ºå­¦ä¹ æé†’
            setInterval(() => {
                const reminders = [
                    'è®°å¾—å¤ä¹ ä»Šå¤©å­¦è¿‡çš„å†…å®¹å“¦ï¼',
                    'è¯•è¯•å’Œä¸åŒçš„æ™ºèƒ½ä½“å¯¹è¯å§ï¼',
                    'è¦ä¸è¦æŒ‘æˆ˜ä¸€ä¸‹æ–°çš„åœºæ™¯ï¼Ÿ',
                    'å­¦ä¹ è¿›åº¦å¾ˆæ£’ï¼Œç»§ç»­åŠ æ²¹ï¼'
                ];
                const randomReminder = reminders[Math.floor(Math.random() * reminders.length)];
                showNotification(randomReminder, 'info');
            }, 600000);
        }

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter å‘é€æ¶ˆæ¯
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                sendMessage();
            }

            // Esc å…³é—­æ¨¡æ€æ¡†
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            // æ•°å­—é”®1-6å¿«é€Ÿåˆ‡æ¢æ™ºèƒ½ä½“
            if (e.key >= '1' && e.key <= '6') {
                const agentIds = ['tanaka', 'koumi', 'ai', 'yamada', 'sato', 'membot'];
                const agentId = agentIds[parseInt(e.key) - 1];
                if (agentId) {
                    toggleAgent(agentId);
                }
            }
        });

        // çª—å£å…³é—­æ—¶çš„æé†’
        window.addEventListener('beforeunload', function(e) {
            if (chatHistory.length > 0) {
                e.preventDefault();
                e.returnValue = 'ç¡®å®šè¦ç¦»å¼€å—ï¼ŸèŠå¤©è®°å½•å°†ä¼šä¸¢å¤±ã€‚';
            }
        });

        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        if (window.innerWidth <= 768) {
            // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
            document.querySelector('.main-layout').style.height = 'auto';
            document.querySelector('.chat-area').style.height = '60vh';

            // è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–
            document.querySelectorAll('.agent-card').forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });

                card.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
        }

        // è¯­éŸ³åŠŸèƒ½å¢å¼º
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            let voiceManager = null;

            // é‡å†™ startVoiceInput å‡½æ•°
            const originalStartVoiceInput = window.startVoiceInput;
            window.startVoiceInput = function() {
                if (!voiceManager) {
                    try {
                        voiceManager = new VoiceInputManager();
                    } catch (error) {
                        console.error('è¯­éŸ³åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:', error);
                        if (originalStartVoiceInput) originalStartVoiceInput();
                        return;
                    }
                }
                voiceManager.startVoiceInput();
            };
        }
    </script>
    <script src="assets/js/voice.js"></script>
    <script src="assets/js/voice-integration.js"></script>
</body>
</html>